<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>duangor-mail</title>
  <style>
    :root{
      --bg:#12131a;
      --panel:#1a1c26;
      --panel2:#161824;
      --stroke:rgba(255,255,255,.16);
      --stroke2:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --gold:#f0d28a;
      --btn:#2a2d3d;
      --btn2:#34384c;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% 20%, rgba(90,95,140,.25), transparent 55%),
                  radial-gradient(900px 600px at 30% 70%, rgba(140,110,80,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .card{
      width:min(980px, 94vw);
      height:min(620px, 88vh);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .inner{
      position:absolute; inset:0;
      padding:34px 40px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .title{
      font-size: clamp(28px, 3.4vw, 52px);
      font-weight: 800;
      letter-spacing:.2px;
      text-align:center;
      margin-top:4px;
      text-shadow: 0 6px 25px rgba(0,0,0,.35);
    }
    .subtitle{
      text-align:center;
      color:var(--gold);
      font-size: clamp(14px, 1.35vw, 18px);
      margin-top:-6px;
      line-height:1.4;
    }
    .subline{
      text-align:center;
      color:var(--muted);
      font-size: clamp(13px, 1.2vw, 16px);
      line-height:1.45;
      margin-top:-8px;
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      margin:10px 0 6px;
    }
    .center{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .btnRow{
      display:flex;
      justify-content:center;
      gap:14px;
      margin-top:8px;
    }
    button{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 18px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transition: transform .08s ease, background .2s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button:active{ transform: translateY(0px) scale(.99); }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 140px;
      height: 38px;
      padding:0 14px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color:rgba(255,255,255,.86);
      font-weight:700;
      font-size:14px;
    }
    .hud{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:8px;
    }
    .hud .pill{min-width:160px}
    .canvasFrame{
      width:min(820px, 92%);
      height: min(380px, 56vh);
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(10,10,16,.20);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
      overflow:hidden;
      position:relative;
    }
    canvas{display:block; width:100%; height:100%;}
    .smallHint{
      text-align:center;
      color:var(--gold);
      font-weight:700;
      font-size:14px;
      margin-top:-6px;
    }

    /* Envelope */
    .envelopeWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
      user-select:none;
    }
    .mailText{
      font-size: clamp(18px, 2vw, 24px);
      font-weight:800;
      color:rgba(255,255,255,.92);
      text-align:center;
      min-height: 32px;
    }
    .envelopeBtn{
      border:none;
      background:none;
      cursor:pointer;
      padding:0;
      display:grid;
      place-items:center;
      width: 180px;
      height: 140px;
    }
    .envelopeSvg{
      width: 170px;
      height: 120px;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.35));
    }
    .flap{
      transform-origin: 100px 40px;
      transform: rotateX(0deg);
      transition: transform 600ms cubic-bezier(.2,.9,.2,1);
    }
    .opened .flap{
      transform: rotateX(160deg);
    }
    .heart{
      transition: transform 600ms cubic-bezier(.2,.9,.2,1);
      transform-origin: 100px 72px;
    }
    .opened .heart{
      transform: translateY(-12px) scale(1.06);
    }

    /* Win coin */
    .winTitle{
      font-size: clamp(42px, 6vw, 86px);
      font-weight: 900;
      text-align:center;
      margin:0;
      letter-spacing:.6px;
    }
    .winSub{
      font-size: clamp(16px, 2vw, 28px);
      color:var(--gold);
      font-weight:800;
      text-align:center;
      margin: 8px 0 0;
    }
    .coinArea{
      margin-top: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .coinLine{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .coin{
      width:66px; height:66px;
      border-radius:50%;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(0,0,0,.22)),
                  radial-gradient(circle at 70% 70%, rgba(0,0,0,.18), rgba(255,255,255,.10));
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
    }
    .coin span{font-size:26px}
    .slot{
      width: 110px;
      height: 44px;
      border-radius: 20px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .slot:before{
      content:"";
      position:absolute; left:16px; right:16px; top:50%;
      height:8px; transform: translateY(-50%);
      border-radius:999px;
      background: rgba(255,255,255,.12);
    }
    .coinInsert{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:block;
      transform: translateX(0) translateY(0) scale(1);
      opacity:1;
    }
    .coin.inserting{ cursor:default; }
    .coin.inserting .coinInsert{
      animation: insertCoin 900ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes insertCoin{
      0%{ transform: translateX(0) translateY(0) scale(1); opacity:1;}
      70%{ transform: translateX(126px) translateY(0) scale(.92); opacity:1;}
      100%{ transform: translateX(126px) translateY(10px) scale(.70); opacity:0;}
    }

    /* Wheel */
    .wheelWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:14px;
      width:100%;
    }
    .wheelCanvas{
      width:min(520px, 80vw);
      height:min(520px, 52vh);
      border-radius: 22px;
      display:grid;
      place-items:center;
      position:relative;
    }
    #wheel{
      width:100%;
      height:100%;
    }
    .pointer{
      position:absolute;
      top:-6px;
      left:50%;
      transform: translateX(-50%);
      width:0; height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-bottom:26px solid rgba(240,210,138,.95);
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.3));
    }
    .wheelMsg{
      min-height:28px;
      font-weight:800;
      color:var(--gold);
      text-align:center;
    }

    /* Confetti */
    .confetti{
      position:absolute; inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .confetti i{
      position:absolute;
      width:10px; height:18px;
      opacity:.95;
      border-radius:3px;
      animation: fall 1200ms linear forwards;
    }
    @keyframes fall{
      0%{ transform: translateY(-30px) rotate(0deg); opacity:1;}
      100%{ transform: translateY(700px) rotate(540deg); opacity:0.9;}
    }

    /* Luck stats */
    .statsTitle{
      font-size: clamp(30px, 3.2vw, 54px);
      font-weight:900;
      text-align:center;
      margin:0;
    }
    .statsHint{
      text-align:center;
      color:var(--muted);
      font-weight:700;
      margin-top:-6px;
    }
    .pageNo{
      position:absolute;
      right:18px;
      bottom:14px;
      color:rgba(255,255,255,.55);
      font-weight:700;
      font-size:13px;
    }
    .statsBox{
      width:min(820px, 94%);
      height:min(380px, 56vh);
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      padding:18px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .statsText{
      font-size: clamp(18px, 2.2vw, 28px);
      font-weight:900;
      color:rgba(255,255,255,.92);
    }

    /* Utility */
    .hidden{display:none !important}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="inner">

      <!-- PAGE 1: Envelope -->
      <section id="page-mail">
        <div class="title">Dear Mr Wong Duan Chiang,</div>
        <div class="subtitle">Have you turned your audio on? Click on the envelope.</div>
        <div class="divider"></div>

        <div class="center">
          <div class="envelopeWrap">
            <button id="envelopeBtn" class="envelopeBtn" aria-label="Open envelope">
              <svg class="envelopeSvg" viewBox="0 0 200 140">
                <!-- envelope body -->
                <rect x="20" y="48" width="160" height="80" rx="12" fill="rgba(255,255,255,.14)" stroke="rgba(255,255,255,.22)"/>
                <path d="M25 56 L100 105 L175 56" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="3"/>
                <path d="M25 124 L85 84" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="3"/>
                <path d="M175 124 L115 84" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="3"/>

                <!-- flap -->
                <g class="flap" id="flap">
                  <path d="M25 56 L100 15 L175 56 L100 95 Z" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)" stroke-width="3"/>
                </g>

                <!-- heart -->
                <g class="heart" id="heart">
                  <path d="M100 88
                           C92 76, 72 76, 72 92
                           C72 110, 92 118, 100 126
                           C108 118, 128 110, 128 92
                           C128 76, 108 76, 100 88 Z"
                        fill="rgba(240,70,80,.95)" stroke="rgba(255,255,255,.22)" stroke-width="2"/>
                </g>
              </svg>
            </button>
            <div class="mailText" id="mailText"></div>
          </div>
        </div>
      </section>

      <!-- PAGE 2: Game -->
      <section id="page-game" class="hidden">
        <div class="title">How OP are you? üéÆ</div>
        <div class="subtitle">Reach 11 to win the game.</div>
        <div class="subline">Tap Start to start the game.<br/>Tap screen to move left/right.</div>

        <div class="hud">
          <div class="pill">Player: dcop</div>
          <div class="pill" id="scorePill">Score: 0/11</div>
          <div class="pill">Goal: 11</div>
        </div>

        <div class="center">
          <div class="canvasFrame" id="gameFrame">
            <canvas id="game"></canvas>
          </div>
        </div>

        <div class="btnRow">
          <button id="startGameBtn">Start</button>
        </div>

        <div class="smallHint" id="gameHint">Tap screen to move left/right.</div>
      </section>

      <!-- PAGE 3: Win + coin -->
      <section id="page-win" class="hidden">
        <div class="center" style="flex-direction:column; gap:8px;">
          <div class="winTitle">YOU WON üèÜ</div>
          <div class="winSub" id="winSubText">Damn, you're an 11/10 indeed.</div>

          <div class="coinArea">
            <div class="winSub" style="font-size:18px; margin-top:8px;">+1 Coin</div>
            <div class="subline" style="margin-top:-4px;">Insert your coin to spin.</div>

            <div class="coinLine">
              <div class="coin" id="coinBtn" title="Click to insert coin">
                <span class="coinInsert">ü™ô</span>
                <span>ü™ô</span>
              </div>
              <div class="slot" aria-hidden="true"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE 4: Wheel -->
      <section id="page-wheel" class="hidden">
        <div class="title">Spin to win üé°</div>
        <div class="divider"></div>

        <div class="center">
          <div class="wheelWrap">
            <div class="wheelCanvas">
              <div class="pointer"></div>
              <canvas id="wheel"></canvas>
              <div class="confetti" id="confetti"></div>
            </div>

            <button id="spinBtn">SPIN</button>
            <div class="wheelMsg" id="wheelMsg"></div>
            <div class="btnRow hidden" id="wheelNextRow">
              <button id="wheelNextBtn">Wild card? Hmmmm</button>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE 5: Aha -->
      <section id="page-aha" class="hidden">
        <div class="center" style="flex-direction:column; gap:18px;">
          <div class="title" style="font-size: clamp(34px, 4.2vw, 64px);">Aha! Thought you were lucky? I'm the luckier one.</div>
          <button id="toStatsBtn">Click to check your luck stats</button>
        </div>
      </section>

      <!-- PAGE 6: Luck Stats -->
      <section id="page-stats" class="hidden">
        <div class="statsTitle">üìä Luck Stats Report</div>
        <div class="statsHint">Swipe left/right.</div>
        <div class="divider"></div>

        <div class="center">
          <div class="statsBox" id="statsBox">
            <div class="statsText" id="statsText">Luck stat: 1</div>
            <div class="pageNo" id="pageNo">1 / 5</div>
          </div>
        </div>

        <div class="btnRow">
          <button id="prevStatBtn">‚óÄ</button>
          <button id="nextStatBtn">‚ñ∂</button>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- AUDIO (filenames EXACTLY match your repo) -->
<audio id="sfxHmm" src="./hmmmm.mp3" preload="auto"></audio>
<audio id="bgm" src="./bgm.mp3" preload="auto" loop></audio>
<audio id="happy" src="./happy.mp3" preload="auto" loop></audio>
<audio id="spinSfx" src="./spin.mp3" preload="auto"></audio>
<audio id="yaySfx" src="./yay.mp3" preload="auto"></audio>
<!-- If you want to use yay-yay-yay.mp3 instead, change yaySfx src above -->

<script>
/* ----------------------------
   Helpers
---------------------------- */
const $ = (id)=>document.getElementById(id);

function show(pageId){
  const pages = ["page-mail","page-game","page-win","page-wheel","page-aha","page-stats"];
  for(const p of pages) $(p).classList.toggle("hidden", p!==pageId);
}

async function safePlay(audioEl){
  try{
    audioEl.currentTime = 0;
    await audioEl.play();
    return true;
  }catch(e){
    // Autoplay restrictions: user gesture required.
    return false;
  }
}
function stopAudio(a){
  try{ a.pause(); a.currentTime = 0; }catch(e){}
}
function pauseAudio(a){
  try{ a.pause(); }catch(e){}
}

/* ----------------------------
   Audio setup
---------------------------- */
const sfxHmm  = $("sfxHmm");
const bgm     = $("bgm");
const happy   = $("happy");
const spinSfx = $("spinSfx");
const yaySfx  = $("yaySfx");

/* ----------------------------
   PAGE 1: Envelope
---------------------------- */
const envelopeBtn = $("envelopeBtn");
const flap = $("flap");
const heart = $("heart");
const mailText = $("mailText");
let mailOpened = false;

envelopeBtn.addEventListener("click", async ()=>{
  if(mailOpened) return;
  mailOpened = true;

  // animate open
  envelopeBtn.classList.add("opened");

  // play hmmmm
  await safePlay(sfxHmm);

  mailText.textContent = "You've got a mail!";

  // go to game after 1.5s
  setTimeout(()=>{
    show("page-game");
  }, 1500);
});

/* ----------------------------
   PAGE 2: Football cones game
   - Move left/right to avoid cones
   - Score increments per cone passed
   - Reach 11 -> WIN
---------------------------- */
const canvas = $("game");
const frame = $("gameFrame");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  const r = frame.getBoundingClientRect();
  canvas.width = Math.floor(r.width * devicePixelRatio);
  canvas.height = Math.floor(r.height * devicePixelRatio);
}
window.addEventListener("resize", resizeCanvas);

const scorePill = $("scorePill");
const startGameBtn = $("startGameBtn");

let running=false, gameOver=false;
let score=0, goal=11;

// player/ball
let px=0.5, py=0.82; // normalized positions
let pTargetX=0.5;
let speed=0.013;     // how fast ball follows target (smooth)

// cones
let cones=[];
let coneSpawnTimer=0;
let coneSpeed=0.010;

function resetGame(){
  score=0;
  cones=[];
  running=false;
  gameOver=false;
  px=0.5; pTargetX=0.5;
  coneSpawnTimer=0;
  coneSpeed=0.010;
  scorePill.textContent = `Score: ${score}/${goal}`;
  $("gameHint").textContent = "Tap screen to move left/right.";
}

function spawnCone(){
  // cone is a pair (left, right) leaving a gap to pass through
  const gap = 0.22;                 // normalized gap width
  const minX = 0.10, maxX = 0.90-gap;
  const gapX = minX + Math.random()*(maxX-minX);
  cones.push({
    y:-0.10,
    gapX,
    gapW:gap,
    passed:false
  });
}

function draw(){
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // background (keep your palette, slightly lighter)
  ctx.fillStyle = "rgba(255,255,255,0.03)";
  ctx.fillRect(0,0,w,h);

  // subtle dots
  ctx.fillStyle = "rgba(255,255,255,0.06)";
  for(let i=0;i<60;i++){
    const x = (i*137)%w;
    const y = (i*73)%h;
    ctx.beginPath();
    ctx.arc(x,y,2*devicePixelRatio,0,Math.PI*2);
    ctx.fill();
  }

  // field lines
  ctx.strokeStyle = "rgba(255,255,255,0.08)";
  ctx.lineWidth = 2*devicePixelRatio;
  ctx.beginPath();
  ctx.moveTo(0, h*0.90);
  ctx.lineTo(w, h*0.90);
  ctx.stroke();

  // cones
  for(const c of cones){
    const y = c.y*h;
    const gapLeft = c.gapX*w;
    const gapRight = (c.gapX + c.gapW)*w;

    // left block (cones)
    drawConeStripe(0, gapLeft, y, h);
    // right block
    drawConeStripe(gapRight, w, y, h);

    // gate marker line
    ctx.strokeStyle = "rgba(240,210,138,0.22)";
    ctx.lineWidth = 2*devicePixelRatio;
    ctx.beginPath();
    ctx.moveTo(gapLeft, y);
    ctx.lineTo(gapRight, y);
    ctx.stroke();
  }

  // player: ball + little jersey icon
  const ballX = px*w;
  const ballY = py*h;

  // jersey
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  const jw = 34*devicePixelRatio, jh=22*devicePixelRatio;
  ctx.roundRect(ballX - jw/2, ballY - 60*devicePixelRatio, jw, jh, 6*devicePixelRatio);
  ctx.fill();

  ctx.fillStyle = "rgba(0,0,0,0.35)";
  ctx.font = `${12*devicePixelRatio}px system-ui`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("27", ballX, ballY - 49*devicePixelRatio);

  // ball
  ctx.fillStyle = "rgba(255,255,255,0.90)";
  ctx.beginPath();
  ctx.arc(ballX, ballY, 14*devicePixelRatio, 0, Math.PI*2);
  ctx.fill();

  ctx.strokeStyle = "rgba(0,0,0,0.35)";
  ctx.lineWidth = 3*devicePixelRatio;
  ctx.beginPath();
  ctx.arc(ballX, ballY, 14*devicePixelRatio, 0, Math.PI*2);
  ctx.stroke();

  // if game over overlay
  if(gameOver){
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillRect(0,0,w,h);

    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.textAlign = "center";
    ctx.font = `${34*devicePixelRatio}px system-ui`;
    ctx.fillText("Nice try.", w/2, h/2 - 22*devicePixelRatio);

    ctx.fillStyle = "rgba(240,210,138,0.95)";
    ctx.font = `${18*devicePixelRatio}px system-ui`;
    ctx.fillText("Refresh to try again (or just win next time).", w/2, h/2 + 18*devicePixelRatio);
  }
}

function drawConeStripe(x0, x1, y, h){
  // draw cone icons near the gate line
  const count = Math.max(3, Math.floor((x1-x0)/(120*devicePixelRatio)));
  for(let i=0;i<count;i++){
    const x = x0 + (i+0.5)*(x1-x0)/count;
    drawCone(x, y);
  }
}

function drawCone(x, y){
  const s = 16*devicePixelRatio;
  ctx.fillStyle = "rgba(240,210,138,0.85)";
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x - s*0.75, y + s*1.5);
  ctx.lineTo(x + s*0.75, y + s*1.5);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "rgba(0,0,0,0.20)";
  ctx.fillRect(x - s*0.55, y + s*0.95, s*1.10, s*0.22);
}

function step(){
  if(!running){ draw(); requestAnimationFrame(step); return; }

  // follow target
  px += (pTargetX - px) * 0.22;
  px = Math.max(0.08, Math.min(0.92, px));

  // spawn cones
  coneSpawnTimer += 1;
  if(coneSpawnTimer > 70){
    coneSpawnTimer = 0;
    spawnCone();
  }

  // move cones
  for(const c of cones){
    c.y += coneSpeed;
    // scoring: when gate passes player's y
    if(!c.passed && c.y > py){
      c.passed = true;

      // check if player is within gap
      const inGap = (px >= c.gapX && px <= c.gapX + c.gapW);
      if(inGap){
        score++;
        scorePill.textContent = `Score: ${score}/${goal}`;

        // speed up slightly
        coneSpeed = Math.min(0.018, coneSpeed + 0.00035);

        if(score >= goal){
          winGame();
          return;
        }
      }else{
        // fail
        endGame(false);
        return;
      }
    }
  }

  // remove offscreen cones
  cones = cones.filter(c => c.y < 1.2);

  draw();
  requestAnimationFrame(step);
}

function endGame(won){
  running=false;
  gameOver=true;
  draw();
}

async function winGame(){
  running=false;
  gameOver=false;

  // lower bgm by 50% AFTER game ends
  bgm.volume = 0.5;

  // play win sfx
  await safePlay(yaySfx);

  // go to win page
  show("page-win");
}

startGameBtn.addEventListener("click", async ()=>{
  if(running) return;
  resetGame();

  // start bgm normally ONLY on Start (user gesture)
  bgm.volume = 1.0;
  await safePlay(bgm);

  running=true;
  step();
});

// touch controls: tap left/right half or drag
let touchActive=false;
frame.addEventListener("pointerdown",(e)=>{
  touchActive=true;
  const r = frame.getBoundingClientRect();
  const x = (e.clientX - r.left)/r.width;
  pTargetX = x;
});
frame.addEventListener("pointermove",(e)=>{
  if(!touchActive) return;
  const r = frame.getBoundingClientRect();
  const x = (e.clientX - r.left)/r.width;
  pTargetX = x;
});
frame.addEventListener("pointerup",()=>touchActive=false);
frame.addEventListener("pointercancel",()=>touchActive=false);

// keyboard controls
window.addEventListener("keydown",(e)=>{
  if(e.key==="ArrowLeft") pTargetX -= 0.06;
  if(e.key==="ArrowRight") pTargetX += 0.06;
  pTargetX = Math.max(0.08, Math.min(0.92, pTargetX));
});

/* ----------------------------
   PAGE 3: Coin insert -> Wheel
---------------------------- */
const coinBtn = $("coinBtn");
let coinInserted=false;

coinBtn.addEventListener("click", async ()=>{
  if(coinInserted) return;
  coinInserted=true;
  coinBtn.classList.add("inserting");

  // little sfx (reuse spin as a coin-ish sound)
  await safePlay(spinSfx);

  setTimeout(()=>{
    show("page-wheel");
    drawWheel(); // ensure wheel ready
  }, 650);
});

/* ----------------------------
   PAGE 4: Wheel (guaranteed Wild Card)
---------------------------- */
const wheel = $("wheel");
const wctx = wheel.getContext("2d");
const spinBtn = $("spinBtn");
const wheelMsg = $("wheelMsg");
const wheelNextRow = $("wheelNextRow");
const wheelNextBtn = $("wheelNextBtn");
const confetti = $("confetti");

let spinning=false;
let wheelAngle=0;

// segments: wild card is SMALL
const segments = [
  {label:"WILD CARD", weight: 1},
  {label:"ATE NIGHT PLANNING", weight: 4},
  {label:"FREE MASSAGE FOR ONYX", weight: 4},
  {label:"ONMYOUJI RAMEN ON ME", weight: 4},
  {label:"XIMO WINS", weight: 4},
];

function resizeWheel(){
  const box = wheel.parentElement.getBoundingClientRect();
  wheel.width = Math.floor(box.width * devicePixelRatio);
  wheel.height = Math.floor(box.height * devicePixelRatio);
}
window.addEventListener("resize", ()=>{ if(!$("page-wheel").classList.contains("hidden")) { resizeWheel(); drawWheel(); } });

function totalWeight(){ return segments.reduce((s,a)=>s+a.weight,0); }

function angleForIndex(i){
  const tw = totalWeight();
  let a0 = 0;
  for(let k=0;k<i;k++) a0 += (segments[k].weight/tw) * Math.PI*2;
  const a1 = a0 + (segments[i].weight/tw) * Math.PI*2;
  return {start:a0, end:a1, mid:(a0+a1)/2};
}

function drawWheel(){
  resizeWheel();
  const W = wheel.width, H = wheel.height;
  const cx = W/2, cy = H/2;
  const R = Math.min(W,H)*0.44;

  wctx.clearRect(0,0,W,H);

  // outer ring
  wctx.lineWidth = 5*devicePixelRatio;
  wctx.strokeStyle = "rgba(255,255,255,0.18)";
  wctx.beginPath();
  wctx.arc(cx,cy,R*1.08,0,Math.PI*2);
  wctx.stroke();

  const tw = totalWeight();
  let a = 0;

  for(let i=0;i<segments.length;i++){
    const seg = segments[i];
    const span = (seg.weight/tw) * Math.PI*2;
    const start = a + wheelAngle;
    const end = a + span + wheelAngle;

    // slice
    const isWild = seg.label === "WILD CARD";
    wctx.fillStyle = isWild ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.05)";
    wctx.strokeStyle = "rgba(255,255,255,0.14)";
    wctx.lineWidth = 2*devicePixelRatio;

    wctx.beginPath();
    wctx.moveTo(cx,cy);
    wctx.arc(cx,cy,R,start,end);
    wctx.closePath();
    wctx.fill();
    wctx.stroke();

    // text: keep readable (upright)
    const mid = (start+end)/2;
    const tx = cx + Math.cos(mid)*R*0.62;
    const ty = cy + Math.sin(mid)*R*0.62;

    wctx.save();
    wctx.translate(tx,ty);

    // Rotate so text is tangent, but flip if upside-down
    let rot = mid + Math.PI/2;
    const norm = ((rot % (Math.PI*2)) + Math.PI*2) % (Math.PI*2);
    if(norm > Math.PI/2 && norm < (Math.PI*1.5)) rot += Math.PI; // flip
    wctx.rotate(rot);

    wctx.fillStyle = "rgba(240,210,138,0.92)";
    wctx.font = `${14*devicePixelRatio}px system-ui`;
    wctx.textAlign = "center";
    wctx.textBaseline = "middle";

    const text = seg.label;
    // wrap if too long
    const maxW = R*0.44;
    const words = text.split(" ");
    let line = "", lines=[];
    for(const w of words){
      const test = (line ? line+" " : "") + w;
      if(wctx.measureText(test).width > maxW && line){
        lines.push(line);
        line = w;
      }else line = test;
    }
    if(line) lines.push(line);

    const lh = 16*devicePixelRatio;
    const offsetY = -((lines.length-1)*lh)/2;
    lines.forEach((ln,idx)=>{
      wctx.fillText(ln, 0, offsetY + idx*lh);
    });

    wctx.restore();

    a += span;
  }

  // center hub
  wctx.fillStyle = "rgba(0,0,0,0.45)";
  wctx.beginPath();
  wctx.arc(cx,cy,R*0.22,0,Math.PI*2);
  wctx.fill();
  wctx.strokeStyle = "rgba(255,255,255,0.14)";
  wctx.lineWidth = 2*devicePixelRatio;
  wctx.stroke();
}

function popConfetti(){
  confetti.innerHTML = "";
  const colors = ["rgba(240,210,138,.95)","rgba(255,255,255,.85)","rgba(240,70,80,.85)","rgba(160,200,255,.75)"];
  const n = 70;
  for(let i=0;i<n;i++){
    const el = document.createElement("i");
    const x = Math.random()*100;
    const delay = Math.random()*120;
    el.style.left = x+"%";
    el.style.top = (-10 - Math.random()*30) + "px";
    el.style.background = colors[i % colors.length];
    el.style.animationDelay = delay+"ms";
    el.style.transform = `rotate(${Math.random()*180}deg)`;
    confetti.appendChild(el);
  }
  // clear later
  setTimeout(()=>confetti.innerHTML="", 1500);
}

// Guaranteed: land on WILD CARD
function targetAngleForLabel(label){
  const idx = segments.findIndex(s=>s.label===label);
  const {mid} = angleForIndex(idx);

  // pointer is at TOP (270deg in canvas with our rotation?),
  // our pointer is at top meaning angle = -PI/2 relative to 0 on +x axis.
  const pointerAngle = -Math.PI/2;

  // We want (wheelAngle + mid) to line up with pointerAngle.
  // => wheelAngle = pointerAngle - mid
  return pointerAngle - mid;
}

spinBtn.addEventListener("click", async ()=>{
  if(spinning) return;
  spinning=true;
  wheelMsg.textContent = "";
  wheelNextRow.classList.add("hidden");

  // play spin sound on click
  await safePlay(spinSfx);

  const forcedLabel = "WILD CARD";
  const target = targetAngleForLabel(forcedLabel);

  // slow spin with multiple turns
  const turns = 6; // more turns = slower dramatic
  const start = wheelAngle;
  const end = target + turns*Math.PI*2;

  const dur = 5200; // slow spin
  const t0 = performance.now();

  function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

  function anim(now){
    const t = Math.min(1, (now - t0)/dur);
    const e = easeOutCubic(t);
    wheelAngle = start + (end-start)*e;
    drawWheel();
    if(t<1){
      requestAnimationFrame(anim);
    }else{
      spinning=false;

      // land result: wild card
      popConfetti();
      safePlay(yaySfx);

      wheelMsg.textContent = "What‚Äôs wild card? Hmmm";
      wheelNextRow.classList.remove("hidden");
    }
  }
  requestAnimationFrame(anim);
});

wheelNextBtn.addEventListener("click", ()=>{
  show("page-aha");
});

/* ----------------------------
   PAGE 5: Aha -> Luck stats
---------------------------- */
$("toStatsBtn").addEventListener("click", async ()=>{
  // when we enter luck stats: ONLY happy music should play.
  // stop bgm completely.
  pauseAudio(bgm);
  bgm.currentTime = 0;

  // start happy music
  await safePlay(happy);

  show("page-stats");
});

/* ----------------------------
   PAGE 6: Luck stats swiper (5 pages)
---------------------------- */
const statsText = $("statsText");
const pageNo = $("pageNo");
const stats = [
  "Luck stat: 1",
  "Luck stat increasing‚Ä¶ 2",
  "Luck stat increasing more‚Ä¶ 3",
  "Luck stat increasing morer‚Ä¶ 4",
  "Luck stat increasing morerest‚Ä¶ 5",
];
let statIdx = 0;

function renderStat(){
  statsText.textContent = stats[statIdx];
  pageNo.textContent = `${statIdx+1} / 5`;
}

$("prevStatBtn").addEventListener("click", ()=>{
  statIdx = (statIdx + stats.length - 1) % stats.length;
  renderStat();
});
$("nextStatBtn").addEventListener("click", ()=>{
  statIdx = (statIdx + 1) % stats.length;
  renderStat();
});

// swipe
let swipeX=null;
$("statsBox").addEventListener("pointerdown",(e)=>{ swipeX = e.clientX; });
$("statsBox").addEventListener("pointerup",(e)=>{
  if(swipeX===null) return;
  const dx = e.clientX - swipeX;
  swipeX=null;
  if(Math.abs(dx) < 30) return;
  if(dx < 0) statIdx = (statIdx + 1) % stats.length;
  else statIdx = (statIdx + stats.length - 1) % stats.length;
  renderStat();
});

/* ----------------------------
   Init
---------------------------- */
(function init(){
  resetGame();
  resizeCanvas();
  draw();
  renderStat();

  // Make roundRect work in older canvases (fallback)
  if(!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+rr, y);
      this.arcTo(x+w, y, x+w, y+h, rr);
      this.arcTo(x+w, y+h, x, y+h, rr);
      this.arcTo(x, y+h, x, y, rr);
      this.arcTo(x, y, x+w, y, rr);
      this.closePath();
      return this;
    }
  }
})();
</script>
</body>
</html>
