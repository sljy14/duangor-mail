<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>You‚Äôve got mail üíå</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0b10;color:#fff}
    .wrap{max-width:760px;margin:0 auto;padding:18px;text-align:center}
    .card{background:#141423;border:1px solid #2a2a44;border-radius:16px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    .hidden{display:none}
    .big{font-size:28px}
    .note{opacity:.85;font-size:14px;line-height:1.35}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid #3a3a66;background:#1d1d33;color:#fff;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .divider{height:1px;background:#2a2a44;margin:16px 0}

    /* Landing envelope */
    .envelope{font-size:140px;cursor:pointer;user-select:none;display:inline-block;line-height:1}
    .envelope:active{transform:scale(.98)}
    .envelopeWrap{margin-top:14px}
    .mailLine{margin-top:10px;font-size:16px;opacity:.92;min-height:22px}

    /* Confetti */
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .confetti i{position:absolute;top:-10px;width:8px;height:10px;opacity:.9;animation:fall 1.8s linear forwards}
    @keyframes fall{to{transform:translateY(120vh) rotate(360deg);opacity:0.1}}

    /* Petals (continuous) */
    .petals{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:50}
    .petals i{
      position:absolute;top:-20px;
      width:10px;height:14px;border-radius:10px 10px 10px 0;
      transform:rotate(25deg);
      opacity:.9;
      animation:petalFall linear forwards;
      filter: blur(.2px);
    }
    @keyframes petalFall{
      to{transform:translateY(120vh) translateX(50px) rotate(220deg);opacity:0.25}
    }

    /* Game */
    canvas.gameCanvas{max-width:520px;width:100%;background:#0f0f1a;border:1px solid #2a2a44;border-radius:14px;touch-action:manipulation}
    .hud{display:flex;justify-content:space-between;gap:10px;max-width:520px;margin:10px auto 0 auto;flex-wrap:wrap}
    .pill{font-size:12px;opacity:.9;border:1px solid #2a2a44;background:rgba(0,0,0,.25);padding:7px 10px;border-radius:999px}

    /* Coin insert */
    .coinSlot{display:inline-flex;align-items:center;gap:12px;margin-top:10px;justify-content:center}
    .coin{font-size:44px;cursor:pointer;user-select:none;display:inline-block}
    .coin.inserted{animation:coinIn .55s ease forwards}
    @keyframes coinIn{
      0%{transform:translateX(0) translateY(0) scale(1)}
      70%{transform:translateX(46px) translateY(-4px) scale(.92)}
      100%{transform:translateX(62px) translateY(-2px) scale(.55);opacity:.15}
    }
    .slot{width:90px;height:22px;border:1px solid #3a3a66;border-radius:12px;position:relative;background:#0b0b10}
    .slot:before{content:"";position:absolute;left:12px;right:12px;top:9px;height:4px;background:#2a2a44;border-radius:10px}

    /* Wheel */
    .wheelBox{position:relative;width:300px;height:300px;margin:0 auto}
    #wheel{width:300px;height:300px;border-radius:50%;border:2px solid #3a3a66;transform:rotate(0deg)}
    .pointer{position:absolute;top:-10px;left:50%;transform:translateX(-50%);font-size:26px}
    .subtitle{opacity:.9;margin-top:6px;min-height:22px}
    .result{margin-top:14px;font-size:16px;min-height:22px}

    /* ‚ÄúAfter spin‚Äù page */
    .bigWinMsg{font-size:34px;line-height:1.15;margin:8px 0 10px 0}
    .hint{opacity:.92;margin-top:6px}

    /* Swipe Book */
    .book{position:relative;max-width:420px;margin:0 auto;height:560px;border-radius:16px;overflow:hidden;border:1px solid #2a2a44;background:#0f0f1a}
    .page{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
    .page img{width:100%;height:100%;object-fit:cover}
    .pageNumber{position:absolute;bottom:10px;right:12px;font-size:12px;opacity:.7;background:rgba(0,0,0,.35);padding:6px 8px;border-radius:10px}
    .caption{
      position:absolute;top:10px;left:10px;right:10px;
      font-size:13px;opacity:.92;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:14px;
      text-align:left;
      backdrop-filter: blur(6px);
    }
    .bonusBtnWrap{position:absolute;bottom:12px;left:12px;right:12px;display:flex;justify-content:center}

    /* Bonus tap page */
    .tapWrap{display:flex;flex-direction:column;gap:12px;align-items:center;margin-top:10px}
    .tapHint{opacity:.88}
    .tapAvatar{cursor:pointer;user-select:none}
    .toast{
      max-width:520px;margin:12px auto 0 auto;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:14px;
      opacity:.92;
      min-height:22px;
    }

    /* Final sunny scene */
    .scene{
      position:relative;
      width:100%;
      max-width:560px;
      margin:0 auto;
      height:520px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid #2a2a44;
      background:linear-gradient(#bfe9ff 0%, #e9fbff 45%, #b8f1b8 45%, #77d477 100%);
    }
    .sun{
      position:absolute;top:22px;left:22px;
      width:90px;height:90px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff7b8 0%, #ffd36a 55%, #ffb84e 100%);
      box-shadow:0 0 40px rgba(255,211,106,.55);
    }
    .cloud{
      position:absolute;top:38px;right:36px;
      width:170px;height:56px;border-radius:40px;
      background:rgba(255,255,255,.85);
      filter: blur(.2px);
    }
    .cloud:before,.cloud:after{
      content:"";position:absolute;background:rgba(255,255,255,.88);border-radius:50%;
    }
    .cloud:before{width:70px;height:70px;left:18px;top:-28px}
    .cloud:after{width:90px;height:90px;left:72px;top:-44px}

    .charLabel{
      position:absolute;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      backdrop-filter: blur(6px);
      transform:translateX(-50%);
      white-space:nowrap;
    }

    .kissIcon{
      position:absolute;
      font-size:34px;
      opacity:0;
      transition:opacity .35s ease;
      z-index:5;
    }

    .finalMsg{
      max-width:560px;margin:12px auto 0 auto;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.16);
      padding:12px 14px;border-radius:14px;
      opacity:0;
      transform:translateY(6px);
      transition:opacity .8s ease, transform .8s ease;
      line-height:1.35;
    }
    .finalMsg.show{opacity:.95;transform:translateY(0)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- S1: Landing -->
    <section id="s1">
      <div class="big">Dear Mr Wong Duan Chiang,</div>
      <p class="note">Have you turned your audio on? Click on the envelope.</p>
      <div class="divider"></div>

      <div class="envelopeWrap">
        <div class="envelope" id="env" title="Click me">üíå</div>
        <div class="mailLine" id="mailLine"></div>
      </div>

      <!-- Audio -->
      <audio id="hmmm" preload="auto" src="hmmmm.mp3"></audio>
      <audio id="bgm" preload="auto" src="bgm.mp3" loop></audio>
      <audio id="happyBgm" preload="auto" src="happy.mp3" loop></audio>
      <audio id="spinSfx" preload="auto" src="spin.mp3"></audio>
      <audio id="yay" preload="auto" src="yay.mp3"></audio>
      <audio id="kissSfx" preload="auto" src="kiss.mp3"></audio>
      <audio id="loveSfx" preload="auto" src="love.mp3"></audio>
    </section>

    <!-- S2: Game -->
    <section id="s2" class="hidden">
      <div class="big">How OP are you? üéÆ</div>
      <p class="note">Reach 11 to win the game.</p>

      <div class="hud">
        <div class="pill"><b>dcop</b></div>
        <div class="pill" id="statusPill">Goal: 11</div>
        <div class="pill">Score: <b id="score">0</b></div>
      </div>

      <div style="margin-top:10px;">
        <canvas class="gameCanvas" id="game" width="520" height="360"></canvas>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;">
        <button class="btn" id="start">Start</button>
        <button class="btn" id="muteMusic">Music: On</button>
      </div>

      <p class="note" id="gameMsg" style="margin-top:10px;">Tap screen to jump.</p>
    </section>

    <!-- S3: Coin -->
    <section id="s3" class="hidden">
      <div class="big">YOU WON üèÜ</div>
      <div class="bigWinMsg">Damn, you‚Äôre an 11/10 indeed!</div>
      <div class="divider"></div>
      <div class="big">ü™ô +1 Coin</div>
      <p class="note">Insert your coin to spin.</p>

      <div class="coinSlot">
        <span class="coin" id="coin" title="Insert coin">ü™ô</span>
        <span class="slot" id="slot" title="coin slot"></span>
      </div>

      <p class="note" id="coinMsg" style="margin-top:8px;"></p>
    </section>

    <!-- S4: Wheel -->
    <section id="s4" class="hidden">
      <div class="big">Spin to win üé°</div>
      <p class="subtitle" id="wheelSubtitle"></p>

      <div class="wheelBox">
        <div class="pointer">üîª</div>
        <canvas id="wheel" width="300" height="300"></canvas>
      </div>

      <div style="margin-top:12px;">
        <button class="btn" id="spin">SPIN</button>
      </div>

      <div style="margin-top:12px;">
        <button class="btn hidden" id="wildBtn">Wild card? Hmmmm</button>
      </div>

      <p class="result" id="wheelResult"></p>
    </section>

    <!-- S4B: After wheel -->
    <section id="s4b" class="hidden">
      <div class="bigWinMsg">Ha! Thought you were lucky? I‚Äôm the luckier one.</div>
      <button class="btn" id="toBook" style="margin-top:10px;">Click to check your luck stats</button>
    </section>

    <!-- S5: Swipe book -->
    <section id="s5" class="hidden">
      <div class="big">üìä Luck Stats Report</div>
      <p class="note">Swipe left/right.</p>
      <div class="book" id="book"></div>
    </section>

    <!-- S6: Bonus tap -->
    <section id="s6" class="hidden">
      <div class="big">Bonus Luck ‚ú®</div>
      <p class="note">Click on <b>dcop</b> to increase your luck stats!</p>

      <div class="tapWrap">
        <div class="tapAvatar" id="tapDcop" title="tap dcop">
          <canvas class="gameCanvas" id="tapCanvas" width="260" height="200" style="max-width:320px;"></canvas>
        </div>
        <div class="toast" id="tapToast"></div>
      </div>
    </section>

    <!-- S7: Final scene -->
    <section id="s7" class="hidden">
      <div class="big">üíñ</div>
      <p class="note" id="finalTop">Congrats! You have increased your girlfriend‚Äôs luck stat to mosterest!</p>

      <div class="scene" id="scene">
        <div class="sun"></div>
        <div class="cloud"></div>

        <!-- kiss icon -->
        <div class="kissIcon" id="kissIcon">üòò</div>

        <!-- dcop + label -->
        <canvas id="dcopBig" width="220" height="240" style="position:absolute;left:80px;bottom:70px;"></canvas>
        <div class="charLabel" id="labelDcop" style="left:190px;bottom:325px;">dcop</div>

        <!-- sljy + label -->
        <canvas id="sljy" width="220" height="240" style="position:absolute;left:360px;bottom:70px;"></canvas>
        <div class="charLabel" id="labelSljy" style="left:470px;bottom:325px;">sljy</div>
      </div>

      <div class="finalMsg" id="finalMsg">
        Happy Valentines mi baby! I‚Äôm the luckiest to have you.<br/>
        With lots of love,<br/>
        Sandra
      </div>
    </section>

  </div>
</div>

<div class="confetti hidden" id="confetti"></div>
<div class="petals hidden" id="petals"></div>

<script>
(() => {
  // ---------- Helpers ----------
  const show = (id) => {
    ["s1","s2","s3","s4","s4b","s5","s6","s7"].forEach(x => document.getElementById(x).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  };

  async function safePlay(audioEl){
    if(!audioEl) return;
    try { await audioEl.play(); } catch(e) {}
  }
  function safePause(audioEl){
    if(!audioEl) return;
    try { audioEl.pause(); } catch(e) {}
  }

  // ---------- Audio ----------
  const hmmm = document.getElementById("hmmm");
  const bgm = document.getElementById("bgm");
  const happyBgm = document.getElementById("happyBgm");
  const spinSfx = document.getElementById("spinSfx");
  const yay = document.getElementById("yay");
  const kissSfx = document.getElementById("kissSfx");
  const loveSfx = document.getElementById("loveSfx");

  let musicOn = true;

  // volumes
  bgm.volume = 1.0;
  happyBgm.volume = 0.25;

  // ---------- Landing ----------
  const env = document.getElementById("env");
  const mailLine = document.getElementById("mailLine");
  env.addEventListener("click", async () => {
    env.textContent = "üì®";
    mailLine.textContent = "You‚Äôve got mail!";
    hmmm.currentTime = 0;
    await safePlay(hmmm);
    let moved = false;
    const go = () => { if(moved) return; moved = true; show("s2"); };
    const t = setTimeout(go, 1700);
    hmmm.onended = () => { clearTimeout(t); go(); };
  });

  // ---------- Game ----------
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const scoreEl = document.getElementById("score");
  const statusPill = document.getElementById("statusPill");
  const gameMsg = document.getElementById("gameMsg");

  let running = false;
  let last = performance.now();
  let score = 0;

  const groundY = 300;
  const gravity = 1200;
  const jumpV = -520;
  const speed = 260;
  const targetScore = 11;

  const p = { x: 120, y: groundY, vy: 0, w: 28, h: 44, onGround: true };
  let spikes = [];
  let spawnTimer = 0;

  let hearts = [];
  function spawnHearts(){
    hearts = [];
    for(let i=0;i<18;i++){
      hearts.push({
        x: p.x + 4 + Math.random()*20,
        y: (p.y - p.h) - 10 + Math.random()*10,
        vx: -80 + Math.random()*160,
        vy: -220 - Math.random()*180,
        life: 0.9 + Math.random()*0.6
      });
    }
  }

  function resetGame(){
    running = false;
    last = performance.now();
    score = 0;
    scoreEl.textContent = "0";
    p.y = groundY; p.vy = 0; p.onGround = true;
    spikes = [];
    spawnTimer = 0;
    hearts = [];
    statusPill.textContent = "Goal: 11";
    gameMsg.textContent = "Tap screen to jump.";
    draw(); // IMPORTANT: always draw
  }

  function jump(){
    if(!running) return;
    if(p.onGround){
      p.vy = jumpV;
      p.onGround = false;
    }
  }

  function spawnSpike(){
    spikes.push({ x: 560, w: 26, h: 34, passed: false });
  }

  function collideRect(ax,ay,aw,ah, bx,by,bw,bh){
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  function lose(){
    running = false;
    statusPill.textContent = "Try again üò≠";
    gameMsg.textContent = "You touched a spike. Press Start and try again.";
  }

  function win(){
    running = false;
    statusPill.textContent = "WIN ‚úÖ";
    gameMsg.textContent = "Damn, you‚Äôre an 11/10 indeed!";
    spawnHearts();

    // DROP BGM volume to 0.25 when game ends/win
    try { bgm.volume = 0.25; } catch(e) {}

    setTimeout(() => show("s3"), 900);
  }

  function update(dt){
    p.vy += gravity * dt;
    p.y += p.vy * dt;

    if(p.y >= groundY){
      p.y = groundY;
      p.vy = 0;
      p.onGround = true;
    }

    spawnTimer -= dt;
    if(spawnTimer <= 0){
      spawnSpike();
      spawnTimer = 0.8 + Math.random() * 0.65;
    }

    spikes.forEach(s => s.x -= speed * dt);
    spikes = spikes.filter(s => s.x > -80);

    for(const s of spikes){
      if(!s.passed && s.x + s.w < p.x){
        s.passed = true;
        score++;
        scoreEl.textContent = String(score);
        if(score >= targetScore){
          win();
          return;
        }
      }
    }

    for(const s of spikes){
      const spikeX = s.x;
      const spikeY = groundY - s.h;
      const hit = collideRect(p.x, p.y - p.h, p.w, p.h, spikeX+3, spikeY+6, s.w-6, s.h-6);
      if(hit){ lose(); return; }
    }

    hearts.forEach(h => {
      h.life -= dt;
      h.vy += 600 * dt;
      h.x += h.vx * dt;
      h.y += h.vy * dt;
    });
    hearts = hearts.filter(h => h.life > 0);

    draw();
  }

  function drawHeart(x,y){
    ctx.fillStyle = "rgba(255,214,231,.95)";
    ctx.fillRect(x, y, 3, 3);
    ctx.fillRect(x+6, y, 3, 3);
    ctx.fillRect(x-3, y+3, 3, 3);
    ctx.fillRect(x+3, y+3, 3, 3);
    ctx.fillRect(x+9, y+3, 3, 3);
    ctx.fillRect(x, y+6, 3, 3);
    ctx.fillRect(x+6, y+6, 3, 3);
    ctx.fillRect(x+3, y+9, 3, 3);
  }

  function drawPixelBoy(ctx2, x, y, scale=1, name="dcop"){
    // x,y is bottom-left anchor
    const w = 28*scale, h = 44*scale;
    const top = y - h;

    // shadow
    ctx2.fillStyle = "rgba(0,0,0,.25)";
    ctx2.fillRect(x+3*scale, y+6*scale, 22*scale, 6*scale);

    // legs/pants
    ctx2.fillStyle = "#1d1d33";
    ctx2.fillRect(x+6*scale, top+28*scale, 7*scale, 14*scale);
    ctx2.fillRect(x+15*scale, top+28*scale, 7*scale, 14*scale);

    // shoes
    ctx2.fillStyle = "#0b0b10";
    ctx2.fillRect(x+5*scale, top+42*scale, 9*scale, 2*scale);
    ctx2.fillRect(x+14*scale, top+42*scale, 9*scale, 2*scale);

    // shirt white
    ctx2.fillStyle = "#f6f6ff";
    ctx2.fillRect(x+5*scale, top+18*scale, 18*scale, 12*scale);

    // arms skin
    ctx2.fillStyle = "#f1d0b5";
    ctx2.fillRect(x+3*scale, top+20*scale, 3*scale, 8*scale);
    ctx2.fillRect(x+23*scale, top+20*scale, 3*scale, 8*scale);

    // head
    ctx2.fillStyle = "#f1d0b5";
    ctx2.fillRect(x+7*scale, top+4*scale, 14*scale, 14*scale);

    // hair
    ctx2.fillStyle = "#0b0b10";
    ctx2.fillRect(x+6*scale, top+2*scale, 16*scale, 6*scale);
    ctx2.fillRect(x+6*scale, top+7*scale, 4*scale, 4*scale);
    ctx2.fillRect(x+10*scale, top+7*scale, 4*scale, 3*scale);
    ctx2.fillRect(x+14*scale, top+7*scale, 4*scale, 4*scale);
    ctx2.fillRect(x+18*scale, top+7*scale, 4*scale, 3*scale);

    // eyes
    ctx2.fillStyle = "#000";
    ctx2.fillRect(x+11*scale, top+10*scale, 2*scale, 2*scale);
    ctx2.fillRect(x+17*scale, top+10*scale, 2*scale, 2*scale);

    // ‚Äú27‚Äù
    ctx2.fillStyle = "#0b0b10";
    ctx2.font = `${10*scale}px system-ui`;
    ctx2.fillText("27", x+10*scale, top+27*scale);

    // name above head
    ctx2.font = `${12*scale}px system-ui`;
    ctx2.fillStyle = "rgba(255,255,255,.92)";
    ctx2.fillText(name, x+1*scale, top-6*scale);
  }

  function drawSpike(s){
    const spikeX = s.x, baseY = groundY, h = s.h, w = s.w;
    ctx.fillStyle = "#2a2a44";
    ctx.beginPath();
    ctx.moveTo(spikeX, baseY);
    ctx.lineTo(spikeX + w/2, baseY - h);
    ctx.lineTo(spikeX + w, baseY);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle = "#3a3a66";
    ctx.stroke();
  }

  function draw(){
    ctx.clearRect(0,0,520,360);
    ctx.fillStyle = "#0f0f1a";
    ctx.fillRect(0,0,520,360);

    ctx.fillStyle = "rgba(255,255,255,.08)";
    for(let i=0;i<30;i++) ctx.fillRect((i*73)%520, (i*41)%260, 2, 2);

    ctx.fillStyle = "#141423";
    ctx.fillRect(0, groundY, 520, 60);
    ctx.fillStyle = "#2a2a44";
    ctx.fillRect(0, groundY, 520, 2);

    spikes.forEach(drawSpike);
    drawPixelBoy(ctx, p.x, p.y, 1, "dcop");
    hearts.forEach(h => drawHeart(h.x, h.y));
  }

  function loop(now){
    const dt = Math.min(0.033, (now - last)/1000);
    last = now;
    if(running) update(dt);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  document.getElementById("start").onclick = async () => {
    resetGame();
    running = true;
    statusPill.textContent = "Goal: 11";
    if(musicOn){
      bgm.currentTime = 0;
      bgm.volume = 1.0; // game bgm loud
      await safePlay(bgm);
    }
  };

  canvas.addEventListener("pointerdown", (e) => { e.preventDefault(); jump(); });

  document.getElementById("muteMusic").onclick = () => {
    musicOn = !musicOn;
    const btn = document.getElementById("muteMusic");
    btn.textContent = musicOn ? "Music: On" : "Music: Off";
    if(!musicOn){
      safePause(bgm); bgm.currentTime = 0;
      safePause(happyBgm); happyBgm.currentTime = 0;
    } else {
      // resume whatever is appropriate later
      safePlay(bgm);
    }
  };

  // draw immediately so game never appears blank
  resetGame();

  // ---------- Coin insert -> wheel ----------
  const coinEl = document.getElementById("coin");
  let coinUsed = false;

  coinEl.onclick = () => {
    if(coinUsed) return;
    coinUsed = true;
    document.getElementById("coinMsg").textContent = "Coin inserted üòè";
    coinEl.classList.add("inserted");
    setTimeout(() => show("s4"), 620);
  };

  // ---------- Confetti ----------
  function confetti(){
    const c = document.getElementById("confetti");
    c.innerHTML="";
    c.classList.remove("hidden");
    for(let i=0;i<70;i++){
      const p=document.createElement("i");
      p.style.left = Math.random()*100+"vw";
      p.style.background = (i%3===0) ? "#fff" : (i%3===1 ? "#b9b9ff" : "#ffd6e7");
      p.style.animationDelay = (Math.random()*0.2)+"s";
      c.appendChild(p);
    }
    setTimeout(()=>c.classList.add("hidden"), 1800);
  }

  // ---------- Wheel (FORCED wild card) ----------
  const wheelSubtitle = document.getElementById("wheelSubtitle");
  const wheel = document.getElementById("wheel");
  const wctx = wheel.getContext("2d");
  const cx=150, cy=150, r=138;

  const segments = [
    { label: "Free massage\nfor girlfriend", weight: 0.2 },
    { label: "You plan\nnext date",        weight: 0.2 },
    { label: "5 mins\nOnyx",               weight: 0.2 },
    { label: "Tomyum ramen\non you",       weight: 0.2 },
    { label: "Wild card",                  weight: 0.2 }
  ];
  const forcedLabel = "Wild card";

  function drawWrappedTextOnRadius(text, maxWidth, baseFont){
    // returns {fontPx, lines}
    const rawLines = text.split("\n");
    let fontPx = baseFont;
    let lines = [...rawLines];

    // shrink until all lines fit
    for(let tries=0; tries<10; tries++){
      wctx.font = `${fontPx}px system-ui`;
      let ok = true;
      for(const ln of lines){
        if(wctx.measureText(ln).width > maxWidth) ok = false;
      }
      if(ok) break;
      fontPx -= 1;
      if(fontPx < 8) break;
    }
    return { fontPx, lines };
  }

  function drawWheel(){
    wctx.clearRect(0,0,300,300);
    let a = 0;
    for(let i=0;i<segments.length;i++){
      const s = segments[i];
      const slice = (Math.PI*2) * s.weight;
      const a0 = a;
      const a1 = a + slice;

      // slice
      wctx.beginPath();
      wctx.moveTo(cx,cy);
      wctx.arc(cx,cy,r,a0,a1);
      wctx.closePath();
      wctx.fillStyle = (i%2===0) ? "#1d1d33" : "#141423";
      wctx.fill();
      wctx.strokeStyle="#3a3a66";
      wctx.stroke();

      // label
      const mid = a0 + slice/2;
      wctx.save();
      wctx.translate(cx,cy);
      wctx.rotate(mid);

      const upsideDown = (mid > Math.PI/2 && mid < (Math.PI*3)/2);
      if(upsideDown) wctx.rotate(Math.PI);

      const textRadius = 88;
      const maxWidth = 110; // conservative so it stays inside slice
      const { fontPx, lines } = drawWrappedTextOnRadius(s.label, maxWidth, 11);

      wctx.fillStyle="rgba(255,255,255,.92)";
      wctx.font=`${fontPx}px system-ui`;
      wctx.textAlign="center";
      wctx.textBaseline="middle";

      // multi-line stack centered
      const lineH = fontPx + 2;
      const totalH = (lines.length-1)*lineH;
      lines.forEach((ln, idx) => {
        const y = (idx*lineH) - totalH/2;
        wctx.fillText(ln, textRadius, y);
      });

      wctx.restore();
      a = a1;
    }

    // hub
    wctx.beginPath();
    wctx.arc(cx,cy,34,0,Math.PI*2);
    wctx.fillStyle="#0b0b10"; wctx.fill();
    wctx.strokeStyle="#3a3a66"; wctx.stroke();
  }
  drawWheel();

  function angleForSegmentLabel(label){
    let a = 0;
    for(const s of segments){
      const slice = (Math.PI*2)*s.weight;
      const mid = a + slice/2;
      const pure = s.label.replace(/\n/g," ").trim().toLowerCase();
      if(pure === label.toLowerCase()) return { mid };
      a += slice;
    }
    // fallback: find contains
    a = 0;
    for(const s of segments){
      const slice = (Math.PI*2)*s.weight;
      const mid = a + slice/2;
      if(s.label.toLowerCase().includes(label.toLowerCase())) return { mid };
      a += slice;
    }
    return { mid: 0 };
  }

  const spinBtn = document.getElementById("spin");
  const wildBtn = document.getElementById("wildBtn");
  let spinning=false;

  spinBtn.onclick = async () => {
    if(spinning) return;
    spinning=true;

    wildBtn.classList.add("hidden");
    wheelSubtitle.textContent = "";
    // spin sound
    spinSfx.currentTime = 0;
    await safePlay(spinSfx);

    // FORCE wild card
    const target = angleForSegmentLabel(forcedLabel);
    const pointerAngle = Math.PI * 1.5; // top
    const turns = 5;
    const targetRot = (Math.PI*2)*turns + (pointerAngle - target.mid);

    const start = performance.now();
    const dur = 3300;

    const anim = (now) => {
      const p = Math.min(1,(now-start)/dur);
      const ease = 1 - Math.pow(1-p, 3);
      const rot = ease * targetRot;
      wheel.style.transform = `rotate(${rot}rad)`;
      if(p<1) requestAnimationFrame(anim);
      else{
        spinning=false;

        // LAND: confetti + yay ONCE (only here)
        confetti();
        yay.currentTime = 0;
        safePlay(yay);

        wheelSubtitle.textContent = "Wild card? Hmmmm";
        wildBtn.classList.remove("hidden");
      }
    };
    requestAnimationFrame(anim);
  };

  wildBtn.onclick = () => {
    show("s4b");
    // switch to happy.mp3 on Aha page
    try {
      if(musicOn){
        safePause(bgm);
        bgm.currentTime = 0;
        happyBgm.currentTime = 0;
        happyBgm.volume = 0.25;
        safePlay(happyBgm);
      }
    } catch(e) {}
  };

  document.getElementById("toBook").onclick = () => show("s5");

  // ---------- Book ----------
  const captions = [
    "Luck stat: 1",
    "Luck stat increasing to‚Ä¶2",
    "Luck stat increasing more‚Ä¶3",
    "Luck stat increasing morer‚Ä¶4",
    "Luck stat increasing morerest‚Ä¶5!"
  ];

  const book = document.getElementById("book");
  let idx = 0;

  function makeImgWithFallback(basePath){
    // try jpg first; fallback to png on error
    const img = document.createElement("img");
    img.alt = "page";
    img.src = basePath + ".jpg";
    img.onerror = () => { img.onerror = null; img.src = basePath + ".png"; };
    return img;
  }

  function renderBook(){
    book.innerHTML="";
    const page = document.createElement("div");
    page.className="page";

    const base = `photos/page${idx+1}`;
    const img = makeImgWithFallback(base);

    const cap = document.createElement("div");
    cap.className="caption";
    cap.textContent = captions[idx];

    const num = document.createElement("div");
    num.className="pageNumber";
    num.textContent = `${idx+1} / 5`;

    page.appendChild(img);
    page.appendChild(cap);
    page.appendChild(num);

    if(idx === 4){
      const wrap = document.createElement("div");
      wrap.className = "bonusBtnWrap";
      wrap.innerHTML = `<button class="btn" id="bonusBtn">Bonus luck here!</button>`;
      page.appendChild(wrap);
      setTimeout(() => {
        const b = document.getElementById("bonusBtn");
        if(b) b.onclick = () => show("s6");
      }, 0);
    }

    book.appendChild(page);
  }
  renderBook();

  let startX=null;
  book.addEventListener("touchstart", (e)=>{ startX = e.touches[0].clientX; }, {passive:true});
  book.addEventListener("touchend", (e)=>{
    if(startX==null) return;
    const endX = e.changedTouches[0].clientX;
    const dx = endX - startX;
    startX=null;
    if(Math.abs(dx) < 35) return;
    if(dx < 0 && idx < 4) idx++;
    if(dx > 0 && idx > 0) idx--;
    renderBook();
  });

  // desktop swipe
  let mouseDown=false, mX=0;
  book.addEventListener("mousedown",(e)=>{mouseDown=true;mX=e.clientX;});
  window.addEventListener("mouseup",(e)=>{
    if(!mouseDown) return;
    mouseDown=false;
    const dx=e.clientX-mX;
    if(Math.abs(dx) < 50) return;
    if(dx < 0 && idx < 4) idx++;
    if(dx > 0 && idx > 0) idx--;
    renderBook();
  });

  // ---------- Bonus tap ----------
  const tapCanvas = document.getElementById("tapCanvas");
  const tctx = tapCanvas.getContext("2d");
  const tapToast = document.getElementById("tapToast");
  const tapDcop = document.getElementById("tapDcop");
  let tapCount = 0;

  function drawTapCard(){
    tctx.clearRect(0,0,tapCanvas.width,tapCanvas.height);
    tctx.fillStyle = "#0f0f1a";
    tctx.fillRect(0,0,tapCanvas.width,tapCanvas.height);

    // tiny stars
    tctx.fillStyle = "rgba(255,255,255,.10)";
    for(let i=0;i<18;i++){
      tctx.fillRect((i*41)%tapCanvas.width, (i*27)%tapCanvas.height, 2,2);
    }

    // ground
    tctx.fillStyle = "#141423";
    tctx.fillRect(0, 160, tapCanvas.width, 40);
    tctx.fillStyle = "#2a2a44";
    tctx.fillRect(0, 160, tapCanvas.width, 2);

    // dcop bigger
    drawPixelBoy(tctx, 115, 160, 2.2, "dcop");
  }
  drawTapCard();

  tapDcop.addEventListener("click", () => {
    tapCount++;
    if(tapCount === 1){
      tapToast.textContent = "Better luck next time! Try again";
    } else if(tapCount === 2){
      tapToast.textContent = "Ohhhhh mans‚Ä¶. Try again!";
    } else {
      // go final
      show("s7");
      startFinalScene();
    }
  });

  // ---------- Petals ----------
  function startPetals(){
    const p = document.getElementById("petals");
    p.innerHTML = "";
    p.classList.remove("hidden");

    // continuous creation
    const makeOne = () => {
      const i = document.createElement("i");
      i.style.left = (Math.random()*100) + "vw";
      i.style.background = (Math.random() < 0.5) ? "rgba(255,182,210,.95)" : "rgba(255,214,231,.95)";
      const dur = 3.2 + Math.random()*2.6;
      i.style.animationDuration = dur + "s";
      i.style.animationTimingFunction = "linear";
      p.appendChild(i);
      setTimeout(() => i.remove(), (dur*1000)+200);
    };

    // spawn rate
    const interval = setInterval(() => {
      for(let k=0;k<4;k++) makeOne();
    }, 250);

    // store so we can stop if needed later
    p.dataset.intv = String(interval);
  }

  // ---------- Final scene (walk + kiss + sounds) ----------
  const dcopBig = document.getElementById("dcopBig");
  const sljy = document.getElementById("sljy");
  const kissIcon = document.getElementById("kissIcon");
  const finalMsg = document.getElementById("finalMsg");
  const finalTop = document.getElementById("finalTop");

  function drawBigDcop(){
    const c = dcopBig.getContext("2d");
    c.clearRect(0,0,dcopBig.width,dcopBig.height);
    // bottom anchor
    drawPixelBoy(c, 70, 220, 4.2, "dcop");
  }

  function drawSljy(){
    const c = sljy.getContext("2d");
    c.clearRect(0,0,sljy.width,sljy.height);

    // Girl pixel: dark brown hair, black tee, black mini skirt, red shoes, label handled by HTML
    const scale = 4.0;
