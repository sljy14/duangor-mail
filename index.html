<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>duangor-mail</title>
  <style>
    :root{
      --bg: #14161b;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --gold: #f5d98b;
      --btn: rgba(255,255,255,.08);
      --btnHover: rgba(255,255,255,.12);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% 10%, rgba(255,255,255,.08), transparent 60%),
                  radial-gradient(900px 600px at 20% 85%, rgba(255,255,255,.06), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px 12px;
    }

    .panel{
      width:min(880px, 92vw);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 22px 18px;
      position:relative;
      overflow:hidden;
    }

    .title{
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing:.2px;
      margin: 0 0 8px 0;
      text-align:center;
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 18px rgba(0,0,0,.35);
    }
    .subtitle{
      text-align:center;
      color: var(--gold);
      font-size: clamp(14px, 1.6vw, 18px);
      margin: 0 0 14px 0;
      line-height:1.55;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0 18px 0;
    }

    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 14px;
      flex-direction:column;
    }

    /* Big envelope */
    .envelopeBtn{
      border: 0;
      background: transparent;
      cursor:pointer;
      padding: 0;
      transform: translateZ(0);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .envelope{
      width: min(240px, 55vw);
      height: auto;
      filter: drop-shadow(0 12px 28px rgba(0,0,0,.45));
      transform-origin: 50% 70%;
      transition: transform .25s ease;
    }
    .envelopeBtn:hover .envelope{ transform: scale(1.03); }
    .envelope.opening{ animation: popOpen .55s ease forwards; }
    @keyframes popOpen{
      0%{ transform: scale(1) rotate(0deg); }
      40%{ transform: scale(1.06) rotate(-2deg); }
      100%{ transform: scale(1.03) rotate(0deg); }
    }

    .hint{
      text-align:center;
      color: rgba(255,255,255,.72);
      margin-top: 4px;
      font-size: 14px;
    }

    /* Game layout */
    .hud{
      display:flex;
      gap: 10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 12px 0;
    }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight: 600;
      font-size: 14px;
      min-width: 120px;
      text-align:center;
    }

    /* Game frame */
    .gameFrame{
      width: 100%;
      aspect-ratio: 16/9;
      max-height: 420px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: #2e2e2e; /* GREY palette */
      overflow:hidden;
      position:relative;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
    }

    .controls{
      display:flex;
      gap: 12px;
      justify-content:center;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.18);
      background: var(--btn);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 700;
      cursor:pointer;
      min-width: 130px;
      text-align:center;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      transition: transform .12s ease, background .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ background: var(--btnHover); transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px); }

    .microHint{
      text-align:center;
      color: var(--gold);
      font-weight:700;
      margin-top: 8px;
    }

    /* Win + coin insert */
    .winTitle{
      font-size: clamp(40px, 6vw, 66px);
      text-align:center;
      margin: 0 0 6px 0;
      color: rgba(255,255,255,.95);
      letter-spacing:.6px;
      text-shadow: 0 2px 18px rgba(0,0,0,.35);
    }
    .winSub{
      text-align:center;
      color: var(--gold);
      font-size: clamp(18px, 2.2vw, 26px);
      margin: 0 0 18px 0;
      font-weight:800;
    }

    .coinRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 18px;
      margin-top: 10px;
    }
    .coin{
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff6d0, #e7c56c 55%, #b78d2c);
      border: 2px solid rgba(0,0,0,.2);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .coin:before{
      content:"";
      position:absolute;
      inset: 10px;
      border-radius: 50%;
      border: 2px dashed rgba(0,0,0,.18);
    }
    .slot{
      width: 130px;
      height: 34px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.22);
      box-shadow: inset 0 6px 14px rgba(0,0,0,.35);
      position:relative;
    }
    .slot:after{
      content:"";
      position:absolute;
      left: 16px;
      right: 16px;
      top: 50%;
      height: 6px;
      transform: translateY(-50%);
      border-radius: 999px;
      background: rgba(255,255,255,.10);
    }

    .coin.inserting{
      animation: coinInsert .75s ease forwards;
    }
    @keyframes coinInsert{
      0%{ transform: translateX(0) translateY(0) scale(1) rotate(0deg); opacity:1; }
      55%{ transform: translateX(110px) translateY(-6px) scale(.9) rotate(25deg); opacity:1; }
      100%{ transform: translateX(130px) translateY(8px) scale(.6) rotate(70deg); opacity:0; }
    }

    /* Wheel */
    .wheelWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 10px 0 6px 0;
    }
    .wheelBox{
      width: min(360px, 78vw);
      aspect-ratio: 1/1;
      position:relative;
    }
    .pointer{
      position:absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 22px solid #ff5a6b;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
      z-index:4;
    }
    #wheelCanvas{
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      display:block;
    }

    .wheelBtnRow{ display:flex; justify-content:center; margin-top: 12px; }

    /* Confetti */
    .confetti{
      position:absolute;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
      z-index: 10;
    }
    .confetti i{
      position:absolute;
      top:-12px;
      width: 10px;
      height: 14px;
      opacity:.95;
      border-radius: 2px;
      animation: fall 1.25s ease-in forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
    @keyframes fall{
      0%{ transform: translateY(0) rotate(0deg); }
      100%{ transform: translateY(520px) rotate(240deg); opacity:0; }
    }

    /* Book / swipe */
    .book{
      width: 100%;
      max-width: 760px;
      margin: 0 auto;
    }
    .bookFrame{
      width:100%;
      aspect-ratio: 4/3;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      position:relative;
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
    }
    .bookFrame img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background: rgba(0,0,0,.25);
    }
    .bookCaption{
      position:absolute;
      left: 14px;
      top: 14px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.9);
      font-weight:800;
    }
    .pageDots{
      text-align:center;
      margin-top: 10px;
      color: rgba(255,255,255,.70);
      font-weight:700;
    }

    /* Hide/show screens */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* Small footer spacing */
    .space8{ height:8px; }
  </style>
</head>

<body>
  <div class="panel">
    <!-- SCREEN 1: Envelope -->
    <section id="s1" class="screen active">
      <h1 class="title">Dear Mr Wong Duan Chiang,</h1>
      <p class="subtitle">Have you turned your audio on? Click on the envelope.</p>
      <div class="divider"></div>

      <div class="center">
        <button id="envelopeBtn" class="envelopeBtn" aria-label="Open mail">
          <!-- simple big envelope graphic -->
          <svg id="envelopeSvg" class="envelope" viewBox="0 0 360 240" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="envG" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#f3f3f6"/>
                <stop offset="1" stop-color="#d9d9e2"/>
              </linearGradient>
              <linearGradient id="heartG" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#ff4b6b"/>
                <stop offset="1" stop-color="#d61f43"/>
              </linearGradient>
            </defs>
            <rect x="24" y="32" width="312" height="176" rx="18" fill="url(#envG)" stroke="rgba(0,0,0,.18)" stroke-width="3"/>
            <path d="M42 58 L180 152 L318 58" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M42 196 L150 120" fill="none" stroke="rgba(0,0,0,.10)" stroke-width="4" stroke-linecap="round"/>
            <path d="M318 196 L210 120" fill="none" stroke="rgba(0,0,0,.10)" stroke-width="4" stroke-linecap="round"/>
            <path d="M180 86
                     C160 58 118 66 118 98
                     C118 132 168 150 180 170
                     C192 150 242 132 242 98
                     C242 66 200 58 180 86Z"
                  fill="url(#heartG)" stroke="rgba(0,0,0,.18)" stroke-width="3"/>
          </svg>
        </button>

        <div id="s1Status" class="hint"></div>
      </div>
    </section>

    <!-- SCREEN 2: Game -->
    <section id="s2" class="screen">
      <h1 class="title">How OP are you? üéÆ</h1>
      <p class="subtitle">
        Reach 11 to win the game.<br>
        Tap Start to start the game.<br>
        Tap screen to jump.
      </p>

      <div class="hud">
        <div class="pill">Player: <span id="playerName">dcop</span></div>
        <div class="pill">Score: <span id="scoreTxt">0</span>/11</div>
        <div class="pill">Goal: 11</div>
      </div>

      <div class="gameFrame" id="gameFrame">
        <canvas id="game"></canvas>
      </div>

      <div class="controls">
        <button class="btn" id="startBtn">Start</button>
      </div>

      <div class="microHint" id="gameHint">Tap screen to jump.</div>
    </section>

    <!-- SCREEN 3: Win / coin -->
    <section id="s3" class="screen">
      <h1 class="winTitle">YOU WON üèÜ</h1>
      <p class="winSub">Damn, you‚Äôre an 11/10 indeed!</p>

      <div class="divider"></div>

      <p class="subtitle" style="margin-top:0">+1 Coin<br>Insert your coin to spin.</p>

      <div class="coinRow">
        <div id="coin" class="coin" title="Click to insert"></div>
        <div class="slot"></div>
      </div>

      <div class="space8"></div>
      <div class="hint" id="coinHint">Click the coin.</div>
    </section>

    <!-- SCREEN 4: Wheel -->
    <section id="s4" class="screen" style="position:relative;">
      <div class="confetti" id="confetti"></div>

      <h1 class="title">Spin to win üé°</h1>
      <p class="subtitle" id="wheelSub"> </p>

      <div class="wheelWrap">
        <div class="wheelBox">
          <div class="pointer"></div>
          <canvas id="wheelCanvas" width="900" height="900"></canvas>
        </div>
      </div>

      <div class="wheelBtnRow">
        <button class="btn" id="spinBtn">SPIN</button>
      </div>

      <div class="space8"></div>
      <div class="center">
        <button class="btn" id="wildBtn" style="display:none; min-width: 240px;">Wild card? Hmmmm</button>
      </div>
    </section>

    <!-- SCREEN 5: Aha page -->
    <section id="s5" class="screen">
      <h1 class="title" style="font-size: clamp(30px, 4vw, 54px);">Aha! Thought you were lucky? I‚Äôm the luckier one.</h1>
      <div class="space8"></div>
      <div class="center">
        <button class="btn" id="toBookBtn" style="min-width: 280px;">Click to check your luck stats</button>
      </div>
    </section>

    <!-- SCREEN 6: Luck Stats book -->
    <section id="s6" class="screen">
      <h1 class="title">üìä Luck Stats Report</h1>
      <p class="subtitle">Swipe left/right.</p>

      <div class="book">
        <div class="bookFrame" id="bookFrame">
          <div class="bookCaption" id="bookCap">Luck stat: 1</div>
          <img id="bookImg" src="" alt="Luck stats page" />
        </div>

        <div class="controls" style="margin-top:14px;">
          <button class="btn" id="prevBtn">‚óÄ</button>
          <button class="btn" id="nextBtn">‚ñ∂</button>
        </div>

        <div class="pageDots" id="pageDots">1 / 5</div>
      </div>
    </section>
  </div>

<script>
  /********************
   * FILES (must exist in repo root)
   ********************/
  const audioHmmm = new Audio('hmmmm.mp3');
  const bgm = new Audio('bgm.mp3');         // ONLY BGM used for game
  const spinSfx = new Audio('spin.mp3');
  const yaySfx  = new Audio('yay-yay-yay.mp3');
  const happy   = new Audio('happy.mp3');

  bgm.loop = true;
  bgm.volume = 1.0;

  happy.loop = true;
  happy.volume = 1.0;

  // iOS autoplay rules: we only play audio after user gesture (click/tap).
  async function safePlay(a){
    try { a.currentTime = 0; await a.play(); } catch(e) {}
  }

  /********************
   * SCREEN NAV
   ********************/
  const screens = {
    s1: document.getElementById('s1'),
    s2: document.getElementById('s2'),
    s3: document.getElementById('s3'),
    s4: document.getElementById('s4'),
    s5: document.getElementById('s5'),
    s6: document.getElementById('s6'),
  };
  function show(id){
    Object.values(screens).forEach(s => s.classList.remove('active'));
    screens[id].classList.add('active');
    window.scrollTo({ top: 0, behavior: 'instant' });
  }

  /********************
   * SCREEN 1: Envelope sequence
   ********************/
  const envelopeBtn = document.getElementById('envelopeBtn');
  const envelopeSvg = document.getElementById('envelopeSvg');
  const s1Status = document.getElementById('s1Status');

  envelopeBtn.addEventListener('click', async () => {
    envelopeBtn.disabled = true;

    // play "hmmmm?"
    await safePlay(audioHmmm);

    // animate envelope opening
    envelopeSvg.classList.add('opening');

    // status text
    s1Status.textContent = "üì¨ You‚Äôve got a mail";

    // auto-transition after 1.5s
    setTimeout(() => {
      show('s2');
    }, 1500);
  });

  /********************
   * SCREEN 2: Game (simple flappy jump over spikes)
   ********************/
  const canvas = document.getElementById('game');
  const frame = document.getElementById('gameFrame');
  const ctx = canvas.getContext('2d');

  const startBtn = document.getElementById('startBtn');
  const scoreTxt = document.getElementById('scoreTxt');

  // Resize canvas to real pixel size
  function resize(){
    const r = frame.getBoundingClientRect();
    canvas.width = Math.floor(r.width * devicePixelRatio);
    canvas.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener('resize', resize);
  resize();

  // Player
  const player = {
    x: 120,
    y: 0,
    vy: 0,
    w: 38,
    h: 48,
    onGround: false
  };

  // Pixel boy-ish colors
  const boy = {
    hair: '#3b1f18',
    skin: '#f2c7a2',
    shirt: '#f2f2f2',
    pants: '#6b6b6b',
    outline: 'rgba(0,0,0,.55)',
    text: '#111',
  };

  let running = false;
  let started = false;
  let score = 0;
  let time = 0;

  // physics
  const g = 0.85;
  const jumpV = -14.5;

  // world
  function groundY(){ return canvas.height - 90 * devicePixelRatio; }

  // spikes
  let spikes = [];
  function spawnSpike(){
    const base = groundY();
    const h = 44 * devicePixelRatio;
    const w = 32 * devicePixelRatio;
    const gap = 240 * devicePixelRatio; // spacing
    const lastX = spikes.length ? spikes[spikes.length-1].x : canvas.width + 160*devicePixelRatio;
    spikes.push({
      x: lastX + gap,
      y: base,
      w, h,
      passed:false
    });
  }
  function resetGame(){
    score = 0;
    scoreTxt.textContent = score;
    time = 0;
    spikes = [];
    for(let i=0;i<6;i++) spawnSpike();
    player.y = groundY() - player.h*devicePixelRatio;
    player.vy = 0;
  }

  function jump(){
    if(!running) return;
    // allow jump anytime like flappy
    player.vy = jumpV * devicePixelRatio;
  }

  // tap/click to jump
  canvas.addEventListener('pointerdown', (e) => {
    if(!started) return;
    jump();
  });

  startBtn.addEventListener('click', async () => {
    if(started) return;
    started = true;
    running = true;
    startBtn.textContent = "Running...";
    startBtn.disabled = true;

    // Start bgm ONLY here
    bgm.volume = 1.0;
    await safePlay(bgm);

    resetGame();
    requestAnimationFrame(loop);
  });

  function drawPixelBoy(px, py){
    // px,py in device pixels
    const s = devicePixelRatio; // scaling factor
    const x = px, y = py;

    // "dcop" label above head
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,.90)';
    ctx.font = `${Math.floor(18*s)}px ui-rounded, system-ui`;
    ctx.textAlign = 'center';
    ctx.fillText('dcop', x + (player.w*s)/2, y - 12*s);
    ctx.restore();

    // body rects (pixel-ish blocks)
    const w = player.w*s, h = player.h*s;

    // outline
    ctx.save();
    ctx.lineWidth = 2*s;
    ctx.strokeStyle = boy.outline;

    // head
    ctx.fillStyle = boy.skin;
    ctx.fillRect(x + 6*s, y + 2*s, 26*s, 18*s);
    ctx.strokeRect(x + 6*s, y + 2*s, 26*s, 18*s);

    // hair fringe
    ctx.fillStyle = boy.hair;
    ctx.fillRect(x + 6*s, y + 2*s, 26*s, 8*s);
    ctx.strokeRect(x + 6*s, y + 2*s, 26*s, 8*s);

    // face dots
    ctx.fillStyle = 'rgba(0,0,0,.55)';
    ctx.fillRect(x + 12*s, y + 10*s, 2*s, 2*s);
    ctx.fillRect(x + 24*s, y + 10*s, 2*s, 2*s);

    // shirt (WHITE) with 27
    ctx.fillStyle = boy.shirt;
    ctx.fillRect(x + 8*s, y + 20*s, 22*s, 16*s);
    ctx.strokeRect(x + 8*s, y + 20*s, 22*s, 16*s);

    // "27"
    ctx.fillStyle = 'rgba(0,0,0,.55)';
    ctx.font = `${Math.floor(11*s)}px ui-rounded, system-ui`;
    ctx.textAlign = 'center';
    ctx.fillText('27', x + 19*s, y + 32*s);

    // pants
    ctx.fillStyle = boy.pants;
    ctx.fillRect(x + 10*s, y + 36*s, 8*s, 12*s);
    ctx.fillRect(x + 20*s, y + 36*s, 8*s, 12*s);

    ctx.strokeRect(x + 10*s, y + 36*s, 8*s, 12*s);
    ctx.strokeRect(x + 20*s, y + 36*s, 8*s, 12*s);

    ctx.restore();
  }

  function drawSpike(sp){
    const base = sp.y;
    const x = sp.x;
    const w = sp.w;
    const h = sp.h;

    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,.75)';
    ctx.strokeStyle = 'rgba(0,0,0,.35)';
    ctx.lineWidth = 2*devicePixelRatio;

    // triangle spike
    ctx.beginPath();
    ctx.moveTo(x, base);
    ctx.lineTo(x + w/2, base - h);
    ctx.lineTo(x + w, base);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    ctx.restore();
  }

  function draw(){
    // background stars
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.fillStyle = '#2e2e2e';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // subtle dots
    ctx.fillStyle = 'rgba(255,255,255,.10)';
    for(let i=0;i<80;i++){
      const rx = (Math.sin(i*12.33 + time*0.0007)+1)/2 * canvas.width;
      const ry = (Math.cos(i*7.77 + time*0.0009)+1)/2 * canvas.height;
      ctx.fillRect(rx, ry, 2*devicePixelRatio, 2*devicePixelRatio);
    }

    // ground
    const gy = groundY();
    ctx.fillStyle = 'rgba(0,0,0,.22)';
    ctx.fillRect(0, gy, canvas.width, canvas.height-gy);
    ctx.strokeStyle = 'rgba(255,255,255,.15)';
    ctx.lineWidth = 2*devicePixelRatio;
    ctx.beginPath();
    ctx.moveTo(0, gy);
    ctx.lineTo(canvas.width, gy);
    ctx.stroke();

    // spikes
    spikes.forEach(drawSpike);

    // player
    drawPixelBoy(player.x*devicePixelRatio, player.y);

    ctx.restore();
  }

  function hitTestSpike(sp){
    const px = player.x*devicePixelRatio;
    const py = player.y;
    const pw = player.w*devicePixelRatio;
    const ph = player.h*devicePixelRatio;

    // bounding box around triangle
    const bx = sp.x;
    const by = sp.y - sp.h;
    const bw = sp.w;
    const bh = sp.h;

    // quick AABB
    if(px + pw < bx || px > bx + bw || py + ph < by || py > by + bh) return false;

    // treat spike area as triangle; approximate with AABB for simplicity (good enough visually)
    return true;
  }

  let last = 0;
  function loop(ts){
    if(!running) return;
    if(!last) last = ts;
    const dt = Math.min(32, ts-last);
    last = ts;
    time += dt;

    // physics
    player.vy += g*devicePixelRatio;
    player.y += player.vy;

    const gy = groundY() - player.h*devicePixelRatio;
    if(player.y > gy){
      player.y = gy;
      player.vy = 0;
    }

    // move spikes left
    const speed = 7.4 * devicePixelRatio;
    spikes.forEach(sp => sp.x -= speed);

    // recycle spikes
    if(spikes.length && spikes[0].x + spikes[0].w < -40*devicePixelRatio){
      spikes.shift();
      spawnSpike();
    }

    // score: each spike passed
    spikes.forEach(sp => {
      const px = player.x*devicePixelRatio;
      if(!sp.passed && sp.x + sp.w < px){
        sp.passed = true;
        score += 1;
        scoreTxt.textContent = score;

        // win at 11
        if(score >= 11){
          win();
        }
      }
    });

    // collision
    for(const sp of spikes){
      if(hitTestSpike(sp)){
        // reset on hit (still keeps it playable)
        resetGame();
        break;
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  function win(){
    running = false;

    // lower BGM AFTER game ends (your rule)
    bgm.volume = 0.5;

    // go to win screen
    setTimeout(() => show('s3'), 250);
  }

  /********************
   * SCREEN 3: Coin insert -> wheel
   ********************/
  const coin = document.getElementById('coin');
  const coinHint = document.getElementById('coinHint');

  let coinInserted = false;
  coin.addEventListener('click', async () => {
    if(coinInserted) return;
    coinInserted = true;
    coin.classList.add('inserting');
    coinHint.textContent = "Nice.";

    // after animation, go to wheel
    setTimeout(() => {
      show('s4');
      drawWheel(); // draw when visible
    }, 900);
  });

  /********************
   * SCREEN 4: Wheel (guaranteed WILD CARD)
   ********************/
  const wheelCanvas = document.getElementById('wheelCanvas');
  const wctx = wheelCanvas.getContext('2d');
  const spinBtn = document.getElementById('spinBtn');
  const wildBtn = document.getElementById('wildBtn');
  const confetti = document.getElementById('confetti');
  const wheelSub = document.getElementById('wheelSub');

  // segments (WILD CARD small slice)
  const segments = [
    { label: '5 MINS ONYX', weight: 4 },
    { label: 'TOMYUM RAMEN ON YOU!', weight: 4 },
    { label: 'FREE MASSAGE FOR GIRLFRIEND', weight: 4 },
    { label: 'DATE NIGHT PLANNING ON YOU!', weight: 4 },
    { label: 'WILD CARD', weight: 1 }
  ];
  const forcedLabel = 'WILD CARD';

  let spinning = false;
  let currentRotation = 0; // radians

  function drawWheel(){
    const W = wheelCanvas.width, H = wheelCanvas.height;
    const cx = W/2, cy = H/2;
    const rOuter = Math.min(W,H)*0.46;
    const rInner = rOuter*0.18;

    wctx.clearRect(0,0,W,H);

    // base circle
    wctx.save();
    wctx.translate(cx, cy);
    wctx.rotate(currentRotation);

    const total = segments.reduce((s,x)=>s+x.weight,0);
    let a = -Math.PI/2; // start at top

    for(let i=0;i<segments.length;i++){
      const seg = segments[i];
      const ang = (seg.weight/total)*Math.PI*2;

      // alternating darks
      const fill = i%2===0 ? 'rgba(255,255,255,.11)' : 'rgba(255,255,255,.06)';
      wctx.beginPath();
      wctx.moveTo(0,0);
      wctx.arc(0,0,rOuter,a,a+ang,false);
      wctx.closePath();
      wctx.fillStyle = fill;
      wctx.fill();

      // separator line
      wctx.strokeStyle = 'rgba(255,255,255,.18)';
      wctx.lineWidth = 4;
      wctx.stroke();

      // text
      const mid = a + ang/2;
      wctx.save();
      wctx.rotate(mid);
      wctx.translate(rOuter*0.62, 0);

      // keep text upright-ish
      wctx.rotate(Math.PI/2);

      wctx.fillStyle = 'rgba(245,217,139,.92)';
      wctx.font = 'bold 34px ui-rounded, system-ui';
      wctx.textAlign = 'center';
      wctx.textBaseline = 'middle';

      // wrap long labels manually
      const txt = seg.label;
      const lines = wrapText(txt, 16);
      if(lines.length === 1){
        wctx.fillText(lines[0], 0, 0);
      }else{
        const lineH = 34;
        const offset = -(lines.length-1)*lineH/2;
        for(let li=0; li<lines.length; li++){
          wctx.fillText(lines[li], 0, offset + li*lineH);
        }
      }

      wctx.restore();

      a += ang;
    }

    // center hub
    wctx.beginPath();
    wctx.arc(0,0,rInner,0,Math.PI*2);
    wctx.fillStyle = 'rgba(0,0,0,.35)';
    wctx.fill();
    wctx.strokeStyle = 'rgba(255,255,255,.18)';
    wctx.lineWidth = 6;
    wctx.stroke();

    wctx.restore();
  }

  function wrapText(s, maxLen){
    // quick wrap by words
    const words = s.split(' ');
    const out = [];
    let line = '';
    for(const w of words){
      const test = line ? (line + ' ' + w) : w;
      if(test.length > maxLen){
        if(line) out.push(line);
        line = w;
      }else{
        line = test;
      }
    }
    if(line) out.push(line);
    return out.slice(0,3); // keep it tidy
  }

  // compute angle that makes forcedLabel land at pointer (top)
  function angleToLandOn(label){
    const total = segments.reduce((s,x)=>s+x.weight,0);
    let a = -Math.PI/2; // start angle
    for(const seg of segments){
      const ang = (seg.weight/total)*Math.PI*2;
      const mid = a + ang/2;
      if(seg.label === label){
        // We want this mid to align with pointer at -PI/2 in screen space.
        // Since wheel rotates by currentRotation, landing means:
        // currentRotation + mid = -PI/2 (mod 2PI) => currentRotation = -PI/2 - mid
        return (-Math.PI/2 - mid);
      }
      a += ang;
    }
    return 0;
  }

  function popConfetti(){
    confetti.innerHTML = '';
    const n = 38;
    for(let i=0;i<n;i++){
      const p = document.createElement('i');
      const left = Math.random()*100;
      const delay = Math.random()*0.10;
      const hue = Math.floor(Math.random()*360);
      p.style.left = left + '%';
      p.style.animationDelay = delay + 's';
      p.style.background = `hsl(${hue} 80% 70%)`;
      p.style.transform = `translateY(0) rotate(${Math.random()*80}deg)`;
      confetti.appendChild(p);
      setTimeout(()=>p.remove(), 1600);
    }
  }

  spinBtn.addEventListener('click', async () => {
    if(spinning) return;
    spinning = true;
    spinBtn.disabled = true;
    wildBtn.style.display = 'none';
    wheelSub.textContent = '';

    // spin sound
    await safePlay(spinSfx);

    // guarantee wild card
    const base = angleToLandOn(forcedLabel);

    // add extra rotations to make it cinematic
    const extraTurns = 6; // slow long spin
    const target = base + extraTurns * Math.PI*2;

    // animate rotation over time (slow easing)
    const startRot = currentRotation;
    const endRot = target;
    const dur = 3600; // ms (slow)
    const t0 = performance.now();

    function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

    function anim(now){
      const t = Math.min(1, (now - t0)/dur);
      const e = easeOutCubic(t);
      currentRotation = startRot + (endRot - startRot) * e;
      drawWheel();
      if(t < 1){
        requestAnimationFrame(anim);
      }else{
        // landed
        popConfetti();
        safePlay(yaySfx);

        // show button AFTER confetti pop
        setTimeout(() => {
          wildBtn.style.display = 'inline-block';
          wheelSub.textContent = "What‚Äôs wild card? Hmmm";
          spinning = false;
        }, 650);
      }
    }
    requestAnimationFrame(anim);
  });

  wildBtn.addEventListener('click', () => {
    show('s5');
  });

  /********************
   * SCREEN 5: To book (switch music)
   ********************/
  const toBookBtn = document.getElementById('toBookBtn');
  toBookBtn.addEventListener('click', async () => {
    // stop bgm fully, start happy music
    try { bgm.pause(); bgm.currentTime = 0; } catch(e){}
    await safePlay(happy);

    show('s6');
    initBook();
  });

  /********************
   * SCREEN 6: Book swipe
   ********************/
  const bookImg = document.getElementById('bookImg');
  const bookCap = document.getElementById('bookCap');
  const pageDots = document.getElementById('pageDots');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const bookFrame = document.getElementById('bookFrame');

  // CHANGE ONLY IF YOU WANT DIFFERENT NAMES
  const bookPages = [
    { src: 'photos/1.jpg', cap: 'Luck stat: 1' },
    { src: 'photos/2.jpg', cap: 'Luck stat increasing‚Ä¶ 2' },
    { src: 'photos/3.jpg', cap: 'Luck stat increasing more‚Ä¶ 3' },
    { src: 'photos/4.jpg', cap: 'Luck stat increasing morer‚Ä¶ 4' },
    { src: 'photos/5.jpg', cap: 'Luck stat increasing morerest‚Ä¶ 5' },
  ];

  let page = 0;
  function renderBook(){
    bookImg.src = bookPages[page].src;
    bookCap.textContent = bookPages[page].cap;
    pageDots.textContent = `${page+1} / ${bookPages.length}`;
  }
  function initBook(){
    page = 0;
    renderBook();
  }

  prevBtn.addEventListener('click', () => {
    page = (page - 1 + bookPages.length) % bookPages.length;
    renderBook();
  });
  nextBtn.addEventListener('click', () => {
    page = (page + 1) % bookPages.length;
    renderBook();
  });

  // swipe support
  let sx = 0, sy = 0;
  bookFrame.addEventListener('touchstart', (e) => {
    if(!e.touches || !e.touches[0]) return;
    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
  }, {passive:true});

  bookFrame.addEventListener('touchend', (e) => {
    const t = e.changedTouches && e.changedTouches[0];
    if(!t) return;
    const dx = t.clientX - sx;
    const dy = t.clientY - sy;
    if(Math.abs(dx) > 45 && Math.abs(dx) > Math.abs(dy)){
      if(dx < 0) nextBtn.click();
      else prevBtn.click();
    }
  }, {passive:true});

  // draw wheel once on load for crispness
  drawWheel();
</script>
</body>
</html>
