<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>duangor-mail</title>
  <style>
    :root{
      --bg0:#0b0c12;
      --bg1:#111320;
      --panel: rgba(22,24,36,.72);
      --stroke: rgba(255,255,255,.18);
      --stroke2: rgba(255,255,255,.10);
      --text:#eef0ff;
      --muted: rgba(238,240,255,.70);
      --gold:#f2d27c;
      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.16);
      --shadow: 0 24px 60px rgba(0,0,0,.55);
      --radius: 26px;
      --radius2: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%; margin:0; background: radial-gradient(1200px 900px at 30% 20%, rgba(93,97,255,.18), transparent 60%),
      radial-gradient(900px 700px at 80% 40%, rgba(255,121,168,.12), transparent 55%),
      linear-gradient(160deg,var(--bg0),var(--bg1)); color:var(--text); font-family:var(--font);}
    *{box-sizing:border-box;}
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px calc(24px + env(safe-area-inset-bottom));
    }
    .card{
      width:min(860px, 92vw);
      min-height:min(680px, 84vh);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(800px 400px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(600px 400px at 80% 30%, rgba(255,255,255,.06), transparent 55%);
      pointer-events:none;
    }
    .inner{position:relative; z-index:1; padding:36px 26px;}
    .center{display:flex; flex-direction:column; align-items:center; text-align:center;}
    h1{margin:0; font-size: clamp(28px, 4.6vw, 54px); letter-spacing:.2px;}
    h2{margin:0; font-size: clamp(22px, 3.8vw, 44px); letter-spacing:.2px;}
    p{margin:10px 0 0; font-size: clamp(14px, 2.0vw, 18px); color:var(--muted); line-height:1.45;}
    .gold{color:var(--gold);}
    .spacer{height:18px;}
    .row{display:flex; gap:14px; flex-wrap:wrap; justify-content:center; align-items:center;}
    .pill{
      padding:10px 14px;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.22);
      color: rgba(238,240,255,.78);
      font-size: 14px;
      min-width: 140px;
      text-align:center;
    }
    .btn{
      appearance:none; border:1px solid var(--stroke);
      background: var(--btn);
      color: var(--text);
      padding: 12px 18px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
      font-weight:600;
      letter-spacing:.2px;
    }
    .btn:hover{background:var(--btn2);}
    .btn:active{transform:scale(.98);}
    .btnWide{min-width: 240px;}
    .hidden{display:none !important;}
    .fadeIn{animation: fadeIn .25s ease both;}
    @keyframes fadeIn{from{opacity:0; transform: translateY(6px);} to{opacity:1; transform: translateY(0);} }

    /* ===== Pages ===== */
    .page{display:none;}
    .page.active{display:block;}

    /* ===== Envelope A (clean) ===== */
    .envelopeWrap{
      margin-top: 26px;
      width:min(520px, 84%);
      height: 280px;
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .envelopeBtn{
      border:0;
      background:transparent;
      cursor:pointer;
      padding:0;
      transform: translateZ(0);
    }
    .envSvg{width: 280px; height: 200px; filter: drop-shadow(0 18px 30px rgba(0,0,0,.35));}
    .envFlap{
      transform-origin: 140px 56px;
      transition: transform .45s cubic-bezier(.2,.9,.2,1);
    }
    .envOpen .envFlap{ transform: rotateX(180deg); }
    .youGotMail{
      position:absolute;
      bottom:28px;
      left:0; right:0;
      font-weight:800;
      font-size: 30px;
      opacity:0;
      transform: translateY(10px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .envOpen .youGotMail{
      opacity:1;
      transform: translateY(0);
    }

    /* ===== Game ===== */
    .gameBox{
      margin: 16px auto 0;
      width:min(520px, 92%);
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--stroke2);
      padding: 14px;
    }
    canvas{
      width:100%;
      height: 360px;
      display:block;
      border-radius: 16px;
      background: radial-gradient(700px 320px at 30% 10%, rgba(255,255,255,.06), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      border:1px solid rgba(255,255,255,.10);
      touch-action: manipulation;
    }
    .tiny{font-size: 13px; color: rgba(238,240,255,.62); margin-top:8px;}

    /* ===== Win + Coin ===== */
    .bigWin{font-size: clamp(38px, 6vw, 70px); font-weight:900; margin-top:6px;}
    .coinArea{
      margin-top: 18px;
      width:min(520px, 92%);
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--stroke2);
      padding: 18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
    }
    .coinRow{display:flex; align-items:center; gap:18px; margin-top:6px;}
    .coin{
      width: 62px; height: 62px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 25%, #fff2b5, #d4a640 55%, #8c6a1f 100%);
      border: 2px solid rgba(255,255,255,.35);
      box-shadow: 0 16px 30px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
    }
    .coin::after{
      content:"";
      position:absolute; inset:14px;
      border-radius: 50%;
      border: 2px dashed rgba(0,0,0,.18);
    }
    .slot{
      width: 120px; height: 28px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.28);
      position:relative;
      overflow:hidden;
    }
    .slot::before{
      content:"";
      position:absolute; inset: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
    }
    .coinInsertAnim{
      animation: insert .85s cubic-bezier(.2,.9,.25,1) forwards;
    }
    @keyframes insert{
      0%{transform: translateX(0) translateY(0) scale(1);}
      55%{transform: translateX(86px) translateY(0) scale(.95);}
      75%{transform: translateX(86px) translateY(6px) scale(.9);}
      100%{transform: translateX(86px) translateY(26px) scale(.2); opacity:0;}
    }

    /* ===== Wheel ===== */
    .wheelWrap{
      margin: 12px auto 0;
      width:min(560px, 96%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 14px;
    }
    .wheelCanvas{
      width: 520px;
      height: 520px;
      max-width: 92vw;
      max-height: 92vw;
      border-radius: 50%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      box-shadow: 0 28px 60px rgba(0,0,0,.45);
      touch-action: manipulation;
    }
    .pointer{
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 26px solid #ff4d7d;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.45));
      margin-top: -6px;
      z-index: 2;
    }
    .subText{font-size: 16px; color: rgba(238,240,255,.72);}

    /* ===== Confetti ===== */
    #confetti{
      position:absolute; inset:0;
      pointer-events:none;
      z-index: 50;
    }

    /* ===== Luck report ===== */
    .reportBox{
      margin: 12px auto 0;
      width:min(640px, 96%);
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--stroke2);
      padding: 18px;
      min-height: 420px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap: 14px;
      user-select:none;
      touch-action: pan-y;
    }
    .reportTop{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      color: rgba(238,240,255,.75);
      font-size: 14px;
    }
    .reportMid{
      flex:1;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding-top: 16px;
      font-weight: 800;
      font-size: 22px;
      color: rgba(238,240,255,.92);
    }
    .reportNav{
      display:flex;
      justify-content:space-between;
      gap: 10px;
    }
    .ghostBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(238,240,255,.85);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 700;
      cursor:pointer;
      min-width: 110px;
    }
    .ghostBtn:active{transform:scale(.98);}
  </style>
</head>

<body>
  <canvas id="confetti" class="hidden"></canvas>

  <div class="wrap">
    <div class="card">
      <div class="inner">

        <!-- PAGE 1: Envelope -->
        <section id="pageEnvelope" class="page active">
          <div class="center">
            <h1>Dear Mr Wong Duan Chiang,</h1>
            <p class="gold">Have you turned your audio on? Click on the envelope.</p>

            <div class="envelopeWrap">
              <button id="envelopeBtn" class="envelopeBtn" aria-label="Open envelope">
                <svg class="envSvg" viewBox="0 0 280 200" xmlns="http://www.w3.org/2000/svg">
                  <!-- body -->
                  <rect x="40" y="60" width="200" height="120" rx="18" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.26)" stroke-width="2"/>
                  <!-- inner X -->
                  <path d="M55 78 L140 140 L225 78" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="2"/>
                  <path d="M55 172 L140 118 L225 172" fill="none" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
                  <!-- flap -->
                  <g class="envFlap" id="envFlap">
                    <path d="M55 78 L140 20 L225 78 Z" fill="rgba(255,255,255,.07)" stroke="rgba(255,255,255,.28)" stroke-width="2"/>
                    <path d="M70 70 L140 40 L210 70" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="2"/>
                  </g>
                  <!-- heart seal -->
                  <g>
                    <path d="M140 155
                             C132 144, 110 144, 110 160
                             C110 176, 132 186, 140 194
                             C148 186, 170 176, 170 160
                             C170 144, 148 144, 140 155 Z"
                          fill="#ff4d7d" opacity=".95" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
                  </g>
                </svg>
              </button>

              <div id="youGotMail" class="youGotMail">You've got a mail!</div>
            </div>
          </div>
        </section>

        <!-- PAGE 2: Game -->
        <section id="pageGame" class="page">
          <div class="center">
            <h1>How OP are you?</h1>
            <p class="gold">Reach 11 to win the game.</p>
            <p>Tap Start to start the game.<br/>Tap screen to move left/right.</p>

            <div class="row" style="margin-top:14px;">
              <div class="pill">Player: dcop</div>
              <div class="pill" id="scorePill">Score: 0/11</div>
              <div class="pill">Goal: 11</div>
            </div>

            <div class="gameBox">
              <canvas id="gameCanvas" width="520" height="360"></canvas>
              <div class="tiny">Tip: tap the left half to move left, right half to move right.</div>
            </div>

            <div class="spacer"></div>
            <button id="startGameBtn" class="btn btnWide">Start</button>
          </div>
        </section>

        <!-- PAGE 3: Win + Coin -->
        <section id="pageWin" class="page">
          <div class="center">
            <div class="bigWin">YOU WON üèÜ</div>
            <p class="gold" style="font-weight:800; font-size:22px; margin-top:10px;">Damn, you‚Äôre an 11/10 indeed!</p>

            <div class="coinArea">
              <h2 style="font-size:34px; margin:0;">+1 Coin</h2>
              <p class="muted" style="margin:0;">Insert your coin to spin.</p>

              <div class="coinRow">
                <div id="coin" class="coin" title="Click to insert"></div>
                <div class="slot" aria-hidden="true"></div>
              </div>

              <p class="tiny" style="margin:0;">(Click the coin.)</p>
            </div>
          </div>
        </section>

        <!-- PAGE 4: Wheel -->
        <section id="pageWheel" class="page">
          <div class="center">
            <h1>Spin to win üé°</h1>

            <div class="wheelWrap">
              <div class="pointer"></div>
              <canvas id="wheelCanvas" class="wheelCanvas" width="520" height="520"></canvas>
              <button id="spinBtn" class="btn btnWide">SPIN</button>
              <div id="wheelAfterText" class="subText hidden"> </div>
              <button id="wildBtn" class="btn btnWide hidden">Wild card? Hmmmm</button>
            </div>
          </div>
        </section>

        <!-- PAGE 5: Aha -->
        <section id="pageAha" class="page">
          <div class="center" style="padding-top:30px;">
            <h1 style="font-size: clamp(30px, 4.8vw, 56px);">Aha! Thought you were lucky? I‚Äôm the luckier one.</h1>
            <div class="spacer"></div>
            <button id="toLuckBtn" class="btn btnWide">Click to check your Luck stats</button>
          </div>
        </section>

        <!-- PAGE 6: Luck Stats -->
        <section id="pageLuck" class="page">
          <div class="center">
            <h1>üìä Luck Stats Report</h1>
            <p>Swipe left/right.</p>

            <div id="reportBox" class="reportBox">
              <div class="reportTop">
                <div id="pageCount">1 / 5</div>
                <div class="muted">Luck Stat</div>
              </div>

              <div id="reportText" class="reportMid">Luck stat: 1</div>

              <div class="reportNav">
                <button id="prevBtn" class="ghostBtn">‚óÄ Prev</button>
                <button id="nextBtn" class="ghostBtn">Next ‚ñ∂</button>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <script>
    // ======================
    // Helpers
    // ======================
    const pages = {
      envelope: document.getElementById('pageEnvelope'),
      game: document.getElementById('pageGame'),
      win: document.getElementById('pageWin'),
      wheel: document.getElementById('pageWheel'),
      aha: document.getElementById('pageAha'),
      luck: document.getElementById('pageLuck'),
    };

    function showPage(key){
      Object.values(pages).forEach(p => p.classList.remove('active'));
      pages[key].classList.add('active');
      window.scrollTo({top:0, behavior:'instant'});
    }

    async function safePlay(audio){
      try{
        audio.currentTime = 0;
        const p = audio.play();
        if(p && typeof p.then === 'function') await p;
      }catch(e){
        // If iOS blocks it, it will still be able to play on the next user gesture.
        console.log('Audio play blocked:', e?.message || e);
      }
    }

    function stopAudio(audio){
      try{ audio.pause(); audio.currentTime = 0; } catch {}
    }

    // ======================
    // Audio (filenames must match repo exactly)
    // ======================
    const sfxHmm   = new Audio('./hmmmm.mp3');
    const bgm      = new Audio('./bgm.mp3');
    const happy    = new Audio('./happy.mp3');
    const spinSfx  = new Audio('./spin.mp3');
    const yayBig   = new Audio('./yay-yay-yay.mp3');
    const yayShort = new Audio('./yay.mp3');

    // recommended settings
    [sfxHmm, spinSfx, yayBig, yayShort].forEach(a => { a.preload = 'auto'; a.volume = 1.0; });
    bgm.preload = 'auto';
    bgm.loop = true;
    bgm.volume = 1.0;
    happy.preload = 'auto';
    happy.loop = true;
    happy.volume = 1.0;

    // ======================
    // PAGE 1: Envelope
    // ======================
    const envelopeBtn = document.getElementById('envelopeBtn');
    const envFlap = document.getElementById('envFlap');
    const youGotMail = document.getElementById('youGotMail');
    let envelopeOpened = false;

    envelopeBtn.addEventListener('click', async () => {
      if(envelopeOpened) return;
      envelopeOpened = true;

      // play Hmmmm (must be triggered by this click for iOS)
      await safePlay(sfxHmm);

      // open flap + show text
      envelopeBtn.classList.add('envOpen'); // toggles flap transform
      youGotMail.classList.add('fadeIn');

      // wait 1.5s then go game
      setTimeout(() => {
        showPage('game');
      }, 1500);
    });

    // ======================
    // PAGE 2: Football Cones Game
    // ======================
    const gameCanvas = document.getElementById('gameCanvas');
    const gctx = gameCanvas.getContext('2d');
    const startGameBtn = document.getElementById('startGameBtn');
    const scorePill = document.getElementById('scorePill');

    // game state
    let gRunning = false;
    let gScore = 0;
    const GOAL = 11;

    const player = {
      x: gameCanvas.width/2,
      y: gameCanvas.height - 56,
      r: 14,
      speed: 34
    };

    let cones = [];
    let lastSpawn = 0;
    let lastTime = 0;

    function resetGame(){
      gRunning = false;
      gScore = 0;
      scorePill.textContent = `Score: ${gScore}/${GOAL}`;
      cones = [];
      player.x = gameCanvas.width/2;
      lastSpawn = 0;
      lastTime = 0;
      drawGame(0);
    }

    function spawnCone(){
      // cone occupies a lane; keep simple
      const laneCount = 5;
      const laneW = gameCanvas.width / laneCount;
      const lane = Math.floor(Math.random() * laneCount);
      const x = laneW * lane + laneW/2;
      cones.push({ x, y: -30, w: 22, h: 30, passed:false });
    }

    function drawCone(c){
      // stylized cone (orange with white stripe)
      gctx.save();
      gctx.translate(c.x, c.y);
      gctx.beginPath();
      gctx.moveTo(0, -c.h/2);
      gctx.lineTo(-c.w/2, c.h/2);
      gctx.lineTo(c.w/2, c.h/2);
      gctx.closePath();
      gctx.fillStyle = 'rgba(255,170,70,.95)';
      gctx.fill();
      gctx.strokeStyle = 'rgba(255,255,255,.22)';
      gctx.lineWidth = 2;
      gctx.stroke();

      // stripe
      gctx.beginPath();
      gctx.moveTo(-c.w*0.28, c.h*0.05);
      gctx.lineTo(c.w*0.28, c.h*0.05);
      gctx.strokeStyle = 'rgba(255,255,255,.55)';
      gctx.lineWidth = 3;
      gctx.stroke();
      gctx.restore();
    }

    function drawBall(){
      gctx.save();
      gctx.translate(player.x, player.y);
      gctx.beginPath();
      gctx.arc(0,0,player.r,0,Math.PI*2);
      gctx.fillStyle = 'rgba(255,255,255,.92)';
      gctx.fill();
      gctx.strokeStyle = 'rgba(0,0,0,.25)';
      gctx.lineWidth = 2;
      gctx.stroke();

      // small pattern
      gctx.beginPath();
      gctx.arc(0,0,player.r*0.45,0,Math.PI*2);
      gctx.fillStyle = 'rgba(0,0,0,.18)';
      gctx.fill();
      gctx.restore();
    }

    function drawPitch(){
      // pitch lines
      gctx.save();
      gctx.strokeStyle = 'rgba(255,255,255,.10)';
      gctx.lineWidth = 2;

      // center lane lines
      const lanes = 5;
      for(let i=1;i<lanes;i++){
        const x = (gameCanvas.width/lanes)*i;
        gctx.beginPath();
        gctx.moveTo(x, 0);
        gctx.lineTo(x, gameCanvas.height);
        gctx.stroke();
      }

      // top arc
      gctx.beginPath();
      gctx.arc(gameCanvas.width/2, 18, 90, 0, Math.PI);
      gctx.stroke();

      gctx.restore();
    }

    function collideBallCone(c){
      const dx = Math.abs(player.x - c.x);
      const dy = Math.abs(player.y - c.y);
      const hitX = dx < (player.r + c.w/2);
      const hitY = dy < (player.r + c.h/2);
      return hitX && hitY;
    }

    function drawGame(t){
      gctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);

      // background vignette
      gctx.save();
      const grd = gctx.createLinearGradient(0,0,0,gameCanvas.height);
      grd.addColorStop(0,'rgba(255,255,255,.05)');
      grd.addColorStop(1,'rgba(0,0,0,.20)');
      gctx.fillStyle = grd;
      gctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);
      gctx.restore();

      drawPitch();

      // cones
      cones.forEach(drawCone);

      // player
      drawBall();

      // little HUD
      gctx.save();
      gctx.fillStyle = 'rgba(238,240,255,.72)';
      gctx.font = '700 14px system-ui, -apple-system, Segoe UI, Roboto';
      gctx.fillText('Tap left/right to dribble', 14, 24);
      gctx.restore();
    }

    function gameLoop(ts){
      if(!gRunning) return;

      if(!lastTime) lastTime = ts;
      const dt = Math.min(32, ts - lastTime);
      lastTime = ts;

      // spawn cones every ~650ms
      lastSpawn += dt;
      if(lastSpawn > 650){
        spawnCone();
        lastSpawn = 0;
      }

      // move cones down
      const speed = 0.23 * dt; // pixels per ms
      cones.forEach(c => c.y += speed * 60);

      // remove cones offscreen, scoring when passed
      cones = cones.filter(c => {
        if(!c.passed && c.y > player.y){
          c.passed = true;
          gScore++;
          scorePill.textContent = `Score: ${gScore}/${GOAL}`;
          if(gScore >= GOAL){
            finishGameWin();
            return false;
          }
        }
        return c.y < gameCanvas.height + 40;
      });

      // collision = reset that cone (no sfx, as requested)
      for(const c of cones){
        if(collideBallCone(c)){
          // gentle penalty: score doesn't drop, but push cone away
          c.y = gameCanvas.height + 999;
        }
      }

      drawGame(ts);
      requestAnimationFrame(gameLoop);
    }

    function movePlayer(dir){
      // dir: -1 left, +1 right
      player.x += dir * player.speed;
      const minX = 24;
      const maxX = gameCanvas.width - 24;
      player.x = Math.max(minX, Math.min(maxX, player.x));
      drawGame(0);
    }

    // tap controls (mobile friendly)
    gameCanvas.addEventListener('pointerdown', (e) => {
      if(!gRunning) return;
      const rect = gameCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width * gameCanvas.width;
      if(x < gameCanvas.width/2) movePlayer(-1);
      else movePlayer(+1);
    });

    startGameBtn.addEventListener('click', async () => {
      if(gRunning) return;

      resetGame();
      gRunning = true;

      // bgm starts here only
      stopAudio(happy);
      bgm.volume = 1.0;
      await safePlay(bgm);

      requestAnimationFrame(gameLoop);
    });

    function finishGameWin(){
      gRunning = false;

      // lower bgm volume by 50% (so later sfx are audible)
      bgm.volume = 0.5;

      // short cheer
      safePlay(yayShort);

      setTimeout(() => {
        showPage('win');
      }, 650);
    }

    // Initialize game view
    resetGame();

    // ======================
    // PAGE 3: Coin Insert
    // ======================
    const coin = document.getElementById('coin');
    let coinInserted = false;

    coin.addEventListener('click', async () => {
      if(coinInserted) return;
      coinInserted = true;
      coin.classList.add('coinInsertAnim');

      // small delay then go wheel
      setTimeout(() => {
        showPage('wheel');
        drawWheel(); // ensure wheel visible
      }, 900);
    });

    // ======================
    // PAGE 4: Wheel (guaranteed wild card)
    // ======================
    const wheelCanvas = document.getElementById('wheelCanvas');
    const wctx = wheelCanvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const wheelAfterText = document.getElementById('wheelAfterText');
    const wildBtn = document.getElementById('wildBtn');

    // Segments: wild is smaller
    const segments = [
      { label: 'DATE NIGHT PLANNING', weight: 3.2 },
      { label: 'FREE MASSAGE FOR', weight: 3.2 },
      { label: 'OMYUM RAMEN ON', weight: 3.2 },
      { label: 'X MINS ONYX', weight: 3.2 },
      { label: 'WILD CARD', weight: 1.0 }, // smaller slice
    ];

    let wheelAngle = 0;
    let spinning = false;

    function drawWheel(){
      const cx = wheelCanvas.width/2;
      const cy = wheelCanvas.height/2;
      const r = wheelCanvas.width/2 - 16;

      wctx.clearRect(0,0,wheelCanvas.width,wheelCanvas.height);

      // base circle
      wctx.save();
      wctx.translate(cx, cy);
      wctx.rotate(wheelAngle);

      const total = segments.reduce((s,a)=>s+a.weight,0);
      let start = -Math.PI/2; // start at top

      for(let i=0;i<segments.length;i++){
        const seg = segments[i];
        const ang = (seg.weight/total) * Math.PI*2;
        const end = start + ang;

        // alternating fills
        wctx.beginPath();
        wctx.moveTo(0,0);
        wctx.arc(0,0,r,start,end);
        wctx.closePath();
        wctx.fillStyle = i % 2 === 0 ? 'rgba(255,255,255,.07)' : 'rgba(0,0,0,.16)';
        wctx.fill();
        wctx.strokeStyle = 'rgba(255,255,255,.12)';
        wctx.lineWidth = 2;
        wctx.stroke();

        // text (readable, not jumbled)
        const mid = (start + end)/2;
        wctx.save();
        wctx.rotate(mid);
        wctx.textAlign = 'center';
        wctx.textBaseline = 'middle';
        wctx.fillStyle = 'rgba(238,240,255,.88)';
        wctx.font = '800 16px system-ui, -apple-system, Segoe UI, Roboto';
        // place text along radius
        wctx.translate(r*0.62, 0);
        wctx.rotate(Math.PI/2);
        // shrink if too long
        let txt = seg.label;
        if(txt.length > 18){
          wctx.font = '800 14px system-ui, -apple-system, Segoe UI, Roboto';
        }
        wctx.fillText(txt, 0, 0);
        wctx.restore();

        start = end;
      }

      // hub
      wctx.beginPath();
      wctx.arc(0,0,42,0,Math.PI*2);
      wctx.fillStyle = 'rgba(0,0,0,.35)';
      wctx.fill();
      wctx.strokeStyle = 'rgba(255,255,255,.14)';
      wctx.lineWidth = 2;
      wctx.stroke();

      wctx.restore();
    }

    function angleForSegmentLabel(label){
      const total = segments.reduce((s,a)=>s+a.weight,0);
      let start = -Math.PI/2;
      for(const seg of segments){
        const ang = (seg.weight/total) * Math.PI*2;
        const end = start + ang;
        if(seg.label === label){
          const mid = (start+end)/2;
          return mid;
        }
        start = end;
      }
      return 0;
    }

    spinBtn.addEventListener('click', async () => {
      if(spinning) return;
      spinning = true;
      wheelAfterText.classList.add('hidden');
      wildBtn.classList.add('hidden');

      // spin sound
      await safePlay(spinSfx);

      // Guarantee: land on WILD CARD under pointer at top.
      // Pointer at top means we want the segment's MID to align with -90deg in world,
      // but we rotate wheel, so we set final wheelAngle so that mid ends at -PI/2.
      const targetMid = angleForSegmentLabel('WILD CARD');
      const targetAngle = (-Math.PI/2) - targetMid;

      // add multiple turns for drama (slow)
      const turns = 6;
      const startAngle = wheelAngle;
      const endAngle = targetAngle + turns*Math.PI*2;

      const duration = 4200; // slow spin
      const start = performance.now();

      function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

      function anim(now){
        const t = Math.min(1, (now - start)/duration);
        const eased = easeOutCubic(t);
        wheelAngle = startAngle + (endAngle - startAngle) * eased;
        drawWheel();
        if(t < 1) requestAnimationFrame(anim);
        else{
          spinning = false;
          onWheelWildCard();
        }
      }

      requestAnimationFrame(anim);
    });

    function onWheelWildCard(){
      // confetti + big yay
      fireConfetti(1700);
      safePlay(yayBig);

      wheelAfterText.textContent = "What‚Äôs wild card? Hmmm";
      wheelAfterText.classList.remove('hidden');
      wildBtn.classList.remove('hidden');
    }

    wildBtn.addEventListener('click', () => {
      // go to Aha page and start happy music here (Option A)
      showPage('aha');

      // switch off bgm fully, start happy.mp3
      stopAudio(bgm);
      safePlay(happy);
    });

    // draw wheel initially
    drawWheel();

    // ======================
    // PAGE 5: Aha -> Luck
    // ======================
    const toLuckBtn = document.getElementById('toLuckBtn');
    toLuckBtn.addEventListener('click', () => {
      showPage('luck');
    });

    // ======================
    // PAGE 6: Luck Stats pages
    // ======================
    const reportBox = document.getElementById('reportBox');
    const reportText = document.getElementById('reportText');
    const pageCount = document.getElementById('pageCount');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const luckPages = [
      'Luck stat: 1',
      'Luck stat increasing‚Ä¶ 2',
      'Luck stat increasing more‚Ä¶ 3',
      'Luck stat increasing morer‚Ä¶ 4',
      'Luck stat increasing morerest‚Ä¶ 5',
    ];
    let luckIndex = 0;

    function renderLuck(){
      reportText.textContent = luckPages[luckIndex];
      pageCount.textContent = `${luckIndex+1} / ${luckPages.length}`;
      prevBtn.disabled = luckIndex === 0;
      nextBtn.disabled = luckIndex === luckPages.length - 1;
      prevBtn.style.opacity = prevBtn.disabled ? .45 : 1;
      nextBtn.style.opacity = nextBtn.disabled ? .45 : 1;
    }

    prevBtn.addEventListener('click', () => {
      if(luckIndex > 0){ luckIndex--; renderLuck(); }
    });
    nextBtn.addEventListener('click', () => {
      if(luckIndex < luckPages.length - 1){ luckIndex++; renderLuck(); }
    });

    // swipe support
    let startX = null;
    reportBox.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
    }, {passive:true});
    reportBox.addEventListener('touchend', (e) => {
      if(startX == null) return;
      const endX = e.changedTouches[0].clientX;
      const dx = endX - startX;
      startX = null;
      if(Math.abs(dx) < 40) return;
      if(dx < 0 && luckIndex < luckPages.length - 1){ luckIndex++; renderLuck(); }
      if(dx > 0 && luckIndex > 0){ luckIndex--; renderLuck(); }
    }, {passive:true});

    renderLuck();

    // ======================
    // Confetti (simple)
    // ======================
    const confettiCanvas = document.getElementById('confetti');
    const cctx = confettiCanvas.getContext('2d');
    let confettiTimer = null;

    function resizeConfetti(){
      confettiCanvas.width = window.innerWidth * devicePixelRatio;
      confettiCanvas.height = window.innerHeight * devicePixelRatio;
    }
    window.addEventListener('resize', resizeConfetti);
    resizeConfetti();

    function fireConfetti(ms=1200){
      confettiCanvas.classList.remove('hidden');
      resizeConfetti();

      const W = confettiCanvas.width;
      const H = confettiCanvas.height;

      const pieces = Array.from({length: 170}, () => ({
        x: Math.random()*W,
        y: -Math.random()*H*0.4,
        r: 4 + Math.random()*6,
        vy: 3 + Math.random()*6,
        vx: -2 + Math.random()*4,
        rot: Math.random()*Math.PI*2,
        vr: -0.2 + Math.random()*0.4,
        a: 0.75 + Math.random()*0.25
      }));

      const start = performance.now();
      function tick(now){
        const t = now - start;
        cctx.clearRect(0,0,W,H);
        for(const p of pieces){
          p.x += p.vx*devicePixelRatio;
          p.y += p.vy*devicePixelRatio;
          p.rot += p.vr;
          cctx.save();
          cctx.translate(p.x,p.y);
          cctx.rotate(p.rot);
          cctx.globalAlpha = p.a;
          cctx.fillStyle = `hsla(${Math.floor(Math.random()*360)}, 90%, 65%, 1)`;
          cctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
          cctx.restore();
        }
        if(t < ms){
          requestAnimationFrame(tick);
        }else{
          confettiCanvas.classList.add('hidden');
          cctx.clearRect(0,0,W,H);
        }
      }
      requestAnimationFrame(tick);
    }
  </script>
</body>
</html>
